<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>밥픽 - 대화상대 선택</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .custom-checkbox {
            appearance: none;
            -webkit-appearance: none;
            border-radius: 9999px;
            border-width: 1px;
        }

        .custom-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-color: #FF7242;
            border-color: #FF7242;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #FF7242;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-white">
    <div class="max-w-lg mx-auto h-screen flex flex-col">
        <header class="flex items-center justify-between p-4 border-b border-gray-200">
            <button onclick="history.back()">
                <svg class="w-6 h-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 class="text-lg font-bold">대화상대 선택</h1>
            <button id="confirm-btn" class="text-gray-400 font-semibold flex items-center gap-2" disabled>
                <span>확인</span>
                <div id="loading-spinner" class="spinner hidden"></div>
            </button>
        </header>

        <div id="group-name-section" class="hidden p-4 border-b border-gray-200 bg-orange-50">
            <label class="block text-sm font-medium text-gray-700 mb-2">그룹 채팅 이름</label>
            <input 
                type="text" 
                id="group-name-input" 
                placeholder="그룹 이름을 입력하세요 (선택사항)"
                class="w-full py-2 px-4 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400"
            >
            <p class="text-xs text-gray-500 mt-1">* 입력하지 않으면 자동으로 멤버 이름으로 설정됩니다</p>
        </div>

        <div class="p-4 border-b border-gray-200">
            <div class="relative">
                <input type="text" id="search-input" placeholder="이름으로 검색" 
                    class="w-full py-2 pl-10 pr-4 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <main id="friends-list" class="flex-1 overflow-y-auto p-4">
            <div class="flex justify-center items-center h-full">
                <div class="spinner" style="width: 40px; height: 40px; border-width: 3px;"></div>
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase SDK import 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "./firebase-config.js"; 

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // FastAPI 서버 URL
        const FASTAPI_BASE_URL = 'http://127.0.0.1:8000'; // 로컬 테스트용
        //const FASTAPI_BASE_URL = "https://bab-back.onrender.com"; 

        let idToken = null;
        let allFriends = [];
        let currentUserUid = null; 
        let selectedFriends = new Set();
        const defaultProfileImg = "https://bit.ly/3K2rlSh";

        const friendsListContainer = document.getElementById('friends-list');
        const searchInput = document.getElementById('search-input');
        const confirmBtn = document.getElementById('confirm-btn');
        const groupNameSection = document.getElementById('group-name-section');
        const groupNameInput = document.getElementById('group-name-input');
        const loadingSpinner = document.getElementById('loading-spinner');

        // 로그인 상태 확인 및 초기화
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert('로그인이 필요합니다.');
                window.location.href = 'index.html';
                return;
            }

            currentUserUid = user.uid; // 현재 사용자 UID 저장
            idToken = await user.getIdToken();
            await loadFriends();
        });

        // 친구 목록 조회
        async function loadFriends() {
            try {
                const res = await fetch(`${FASTAPI_BASE_URL}/friends/list`, {
                    headers: { "Authorization": `Bearer ${idToken}` }
                });

                if (!res.ok) throw new Error('친구 목록 로드 실패');

                const data = await res.json(); 

                // API 응답이 배열인지 객체인지 확인
                if (Array.isArray(data)) {
                    allFriends = data;
                } else if (data.friends && Array.isArray(data.friends)) {
                    allFriends = data.friends;
                } else {
                    allFriends = [];
                }
                
                renderFriends(allFriends);
            } catch (err) {
                console.error('친구 목록 로드 오류:', err);
                friendsListContainer.innerHTML = `
                    <div class="text-center text-red-500 mt-4">
                        <p>친구 목록을 불러올 수 없습니다. 서버 상태를 확인하세요.</p>
                        <button onclick="location.reload()" class="mt-2 text-orange-500 underline">다시 시도</button>
                    </div>
                `;
            }
        }

        // 친구 목록 렌더링
        function renderFriends(friends) {
            friendsListContainer.innerHTML = '';
            
            if (friends.length === 0) {
                friendsListContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">친구가 없습니다.</p>';
                return;
            }

            friends.forEach(friend => {
                const friendElement = document.createElement('label');
                friendElement.className = 'flex items-center p-2 rounded-lg hover:bg-gray-50 cursor-pointer';
                
                const profileImg = friend.profile_image || defaultProfileImg;
                
                friendElement.innerHTML = `
                    <img src="${profileImg}" class="w-10 h-10 rounded-full mr-4 object-cover" alt="${friend.nickname}">
                    <span class="flex-1 text-gray-800">${friend.nickname}</span>
                    <input type="checkbox" class="custom-checkbox w-5 h-5 border-gray-300 focus:ring-transparent" data-uid="${friend.firebase_uid}" ${selectedFriends.has(friend.firebase_uid) ? 'checked' : ''}>
                `;
                friendsListContainer.appendChild(friendElement);
            });
        }

        function updateConfirmButton() {
            const count = selectedFriends.size;
            
            if (count > 0) {
                confirmBtn.disabled = false;
                confirmBtn.querySelector('span').textContent = `확인 (${count})`;
                confirmBtn.classList.remove('text-gray-400');
                confirmBtn.classList.add('text-orange-500');
                
                // 1명 이상 선택 시 그룹 이름 입력 섹션 표시
                groupNameSection.classList.remove('hidden');
            } else {
                confirmBtn.disabled = true;
                confirmBtn.querySelector('span').textContent = '확인';
                confirmBtn.classList.add('text-gray-400');
                confirmBtn.classList.remove('text-orange-500');
                groupNameSection.classList.add('hidden');
            }
        }

        // 검색 기능 (로컬 필터링)
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredFriends = allFriends.filter(friend => 
                friend.nickname.toLowerCase().includes(searchTerm)
            );
            renderFriends(filteredFriends);
        });

        // 체크박스 선택 이벤트 핸들러
        friendsListContainer.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const friendUid = e.target.dataset.uid;
                if (e.target.checked) {
                    selectedFriends.add(friendUid);
                } else {
                    selectedFriends.delete(friendUid);
                }
                updateConfirmButton();
                const searchTerm = searchInput.value.toLowerCase();
                const filteredFriends = allFriends.filter(friend => 
                    friend.nickname.toLowerCase().includes(searchTerm)
                );
                renderFriends(filteredFriends);
            }
        });

        // 그룹 채팅방 생성
        confirmBtn.addEventListener('click', async () => {
            if (selectedFriends.size === 0) return;

            // 로딩 상태
            confirmBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            confirmBtn.querySelector('span').textContent = '생성 중';

            try {
                const groupName = groupNameInput.value.trim() || null;
                const invitedUids = Array.from(selectedFriends);

                const res = await fetch(`${FASTAPI_BASE_URL}/chat/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        name: groupName,
                        is_group: invitedUids.length >= 1, 
                        invited_uids: invitedUids
                    })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.detail || '채팅방 생성 실패');
                }

                const data = await res.json();
                
                // 생성된 채팅방으로 이동 (data.chatroom_id 필요)
                window.location.href = `chat.html?roomId=${data.chatroom_id}`;

            } catch (err) {
                console.error('채팅방 생성 오류:', err);
                alert(`채팅방 생성 실패: ${err.message}`);
                
                // 로딩 해제
                loadingSpinner.classList.add('hidden');
                updateConfirmButton(); // 버튼 텍스트와 disabled 상태 복구
            }
        });
    </script>
</body>
</html>