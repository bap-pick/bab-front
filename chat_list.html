<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… ëª©ë¡</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            padding-bottom: 80px;
        }

        .popup-hidden {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
            transition: all 0.2s ease-out;
            pointer-events: none;
        }

        .popup-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            transition: all 0.2s ease-in;
            pointer-events: auto;
        }

        .tab-active {
            color: #EF633A;
            font-weight: 700;
            border-bottom-width: 2px;
            border-color: #EF633A;
        }

        .tab-inactive {
            color: #6b7280;
            font-weight: 500;
        }

        .chat-list-item {
            position: relative;
            overflow: hidden;
            background-color: white;
        }

        .swipeable-content {
            position: relative;
            z-index: 10;
            background-color: inherit;
        }

        .swipe-action {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 80px;
            z-index: 1;
        }
    </style>
</head>

<body>

    <div class="w-full h-full bg-white max-w-2xl mx-auto flex flex-col">
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-20 z-40 hidden transition-opacity"></div>

        <div id="add-friend-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">

                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">ì¹œêµ¬ ì¶”ê°€</h3>
                    <p class="text-gray-500 mb-4">ì¶”ê°€í•  ì¹œêµ¬ì˜ ë‹‰ë„¤ì„ì„ ê²€ìƒ‰í•˜ì„¸ìš”.</p>
                    <div class="relative">
                        <input id="friend-nickname-input" type="text" placeholder="ì¹œêµ¬ ë‹‰ë„¤ì„" class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-400">
                    </div>
                    <button id="search-friend-btn" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 font-medium flex-shrink-0">
                        ê²€ìƒ‰
                    </button>
                    <div id="profile-list-container" class="mt-4 hidden space-y-2 max-h-48 overflow-y-auto">
                    </div>
                </div>

                <hr class="border-gray-200">
                <div class="p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">ë°›ì€ ì¹œêµ¬ ìš”ì²­</h4>

                     <div id="friend-request-list" class="space-y-3 max-h-48 overflow-y-auto">

                        <p id="no-requests-text" class="text-sm text-gray-500 hidden text-center p-2">
                             ë°›ì€ ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </p>
        
                        </div>
                </div>

                <div class="bg-gray-50 px-6 py-3 flex justify-end rounded-b-lg">
                    <button id="cancel-add-friend-btn"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-medium">ë‹«ê¸°</button>
                </div>
            </div>
        </div>

        <div id="chat-list-screen" class="h-full flex flex-col relative">

            <header class="h-16 bg-white border-b border-gray-200 flex-shrink-0">
                <div id="header-main" class="grid grid-cols-3 items-center h-full px-4">
                    <div></div>
                    <h1 class="text-xl font-bold text-gray-800 text-center">ì±„íŒ…</h1>
                    <div class="flex items-center space-x-3 justify-self-end">
                        <button id="search-btn" class="text-gray-500 hover:text-gray-800">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </button>
                        <button id="add-friend-btn" class="text-gray-500 hover:text-gray-800">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <line x1="19" y1="8" x2="19" y2="14"></line>
                                <line x1="22" y1="11" x2="16" y2="11"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="header-search" class="hidden flex items-center gap-2 h-full px-4">
                    <input type="text" id="chat-search-input" placeholder="ì±„íŒ…ë°© ê²€ìƒ‰"
                        class="w-full px-3 py-1.5 border-gray-200 bg-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-400">
                    <button id="cancel-search-btn"
                        class="text-gray-600 hover:text-gray-900 text-sm font-medium flex-shrink-0">ì·¨ì†Œ</button>
                </div>
            </header>

            <div class="flex border-b border-gray-200 bg-white flex-shrink-0">
                <button id="tab-private" class="flex-1 py-3 text-center tab-active">
                    1:1 ì±„íŒ…
                </button>
                <button id="tab-group" class="flex-1 py-3 text-center tab-inactive">
                    ë‹¨ì²´ ì±„íŒ…
                </button>
            </div>

            <main id="main-content" class="flex-1 overflow-y-auto bg-gray-50">

                <div id="chat-list-private">
                    <ul class="space-y-3 p-4 bg-white">
                    </ul>
                </div>

                <div id="chat-list-group" class="hidden">
                    <ul class="space-y-3 p-4 bg-white">
                    </ul>
                </div>
            </main>

            <div id="add-chat-popup"
                class="absolute bottom-24 left-1/2 -translate-x-1/2 w-48 bg-white rounded-md shadow-xl z-50 popup-hidden">
                <div class="py-2">
                    <a href="chat_list.html"
                        class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="8" y1="6" x2="21" y2="6"></line>
                            <line x1="8" y1="12" x2="21" y2="12"></line>
                            <line x1="8" y1="18" x2="21" y2="18"></line>
                            <line x1="3" y1="6" x2="3.01" y2="6"></line>
                            <line x1="3" y1="12" x2="3.01" y2="12"></line>
                            <line x1="3" y1="18" x2="3.01" y2="18"></line>
                        </svg>
                        ì±„íŒ… ëª©ë¡
                    </a>
                    <a href="chat.html" id="start-private-chat-btn"
                        class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                        </svg>
                        1:1 ì±„íŒ…ë°©
                    </a>
                    <a href="chat_group.html"
                        class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                            <path d="M18 21v-2a4 4 0 0 0-4-4h-1" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M18 7h3a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1h-3" />
                            <path d="m15.5 13.5-3-3 3-3" />
                        </svg>
                        ë‹¨ì²´ ì±„íŒ…ë°©
                    </a>
                </div>
            </div>

            <footer class="fixed bottom-0 left-0 right-0 z-30 max-w-2xl mx-auto">
                <nav
                    class="flex justify-around items-center h-16 bg-white rounded-t-2xl shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
                    <a href="home.html"
                        class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                        <span class="mt-1">í™ˆ</span>
                    </a>
                    <a href="calender.html"
                        class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <span class="mt-1">ìº˜ë¦°ë”</span>
                    </a>
                    <div class="w-1/5"></div> <a href="scrap.index.html"
                        class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <span class="mt-1">ìŠ¤í¬ë©</span>
                    </a>
                    <a href="mypage.index.html"
                        class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span class="mt-1">ë§ˆì´</span>
                    </a>
                </nav>
            </footer>

            <button id="add-chat-btn"
                class="fixed bottom-6 left-1/2 -translate-x-1/2 w-16 h-16 bg-[#FF7242] hover:bg-orange-600 text-white rounded-full flex items-center justify-center shadow-lg z-40">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "./firebase-config.js";

        // Firebase ì•± ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // api url
        //const FASTAPI_BASE_URL = "https://bab-back.onrender.com";
        const FASTAPI_BASE_URL = 'http://127.0.0.1:8000'; // ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©

        // UI ìš”ì†Œ
        const overlay = document.getElementById('overlay');
        const addChatBtn = document.getElementById('add-chat-btn');
        const addChatPopup = document.getElementById('add-chat-popup');
        const addFriendBtn = document.getElementById('add-friend-btn');
        const addFriendModal = document.getElementById('add-friend-modal');
        const cancelAddFriendBtn = document.getElementById('cancel-add-friend-btn');
        const friendEmailInput = document.getElementById('friend-nickname-input');
        const profileListContainer = document.getElementById('profile-list-container');

        const tabPrivate = document.getElementById('tab-private');
        const tabGroup = document.getElementById('tab-group');
        const chatListPrivate = document.getElementById('chat-list-private');
        const chatListGroup = document.getElementById('chat-list-group');

        const searchBtn = document.getElementById('search-btn');
        const cancelSearchBtn = document.getElementById('cancel-search-btn');
        const headerMain = document.getElementById('header-main');
        const headerSearch = document.getElementById('header-search');
        const chatSearchInput = document.getElementById('chat-search-input');

        const searchInput = document.getElementById('friend-nickname-input');
        const searchButton = document.getElementById('search-friend-btn');

        const startPrivateChatBtn = document.getElementById('start-private-chat-btn');

        let currentUser = null;
        let searchTimeout;

        // ì¹œêµ¬ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° ì´ë²¤íŠ¸
        addFriendBtn.addEventListener('click', () => {
            addFriendModal.classList.remove('hidden');
            addFriendModal.classList.add('flex');

            // ë°›ì€ ì¹œêµ¬ ìš”ì²­ ëª©ë¡ ì¡°íšŒ í•¨ìˆ˜ ì¶”ê°€
            loadFriendRequests(); 
        });

        cancelAddFriendBtn.addEventListener('click', () => {
            addFriendModal.classList.add('hidden');
            addFriendModal.classList.remove('flex');
        });

        // =========================================================================
        // 1. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: Debounce (API í˜¸ì¶œ ê³¼ë¶€í•˜ ë°©ì§€)
        // =========================================================================
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // =========================================================================
        // 2. ê²€ìƒ‰ ê²°ê³¼ ë‹¨ì¼ ì‚¬ìš©ì í”„ë¡œí•„ HTML ë Œë”ë§
        // =========================================================================
        // =========================================================================

        function renderUserSearchResult(user) {
            // í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—†ì„ ê²½ìš°ë¥¼ ìœ„í•œ ê¸°ë³¸ ì´ë¯¸ì§€
            const defaultProfileImg = "https://via.placeholder.com/100?text=Profile";
            
            let buttonHtml = '';
            
            // -----------------------------------------------------------------
            // ğŸŒŸ ê´€ê³„ ìƒíƒœ(relation_status)ì— ë”°ë¥¸ ë²„íŠ¼/ìƒíƒœ ë©”ì‹œì§€ ê²°ì • ë¡œì§ ì¶”ê°€
            // -----------------------------------------------------------------
            if (user.relation_status === "friend") {
                // 1. ì´ë¯¸ ì¹œêµ¬ì¸ ê²½ìš°
                buttonHtml = `<span class="text-sm text-green-500 font-medium px-3 py-1 rounded-md bg-green-100">ì¹œêµ¬</span>`;
            } else if (user.relation_status === "sent_request") {
                // 2. ë‚´ê°€ ì´ë¯¸ ìš”ì²­ì„ ë³´ë‚¸ ê²½ìš° (ìš”ì²­ ì™„ë£Œ)
                buttonHtml = `<span class="text-sm text-gray-500 font-medium px-3 py-1 rounded-md bg-gray-100">ìš”ì²­ ì™„ë£Œ</span>`;
            } else if (user.relation_status === "received_request") {
                // 3. ìƒëŒ€ë°©ì´ ë‚˜ì—ê²Œ ìš”ì²­ì„ ë³´ë‚¸ ê²½ìš° (ë°›ì€ ìš”ì²­ ëª©ë¡ì—ì„œ ì²˜ë¦¬í•´ì•¼ í•¨)
                // ì—¬ê¸°ì„œëŠ” ë³„ë„ ì²˜ë¦¬ ì—†ì´ ë²„íŠ¼ì„ í‘œì‹œí•˜ì§€ ì•Šê±°ë‚˜, ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìš”ì²­ ëª©ë¡ìœ¼ë¡œ ì•ˆë‚´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                // í˜„ì¬ëŠ” 'ìš”ì²­ë°›ìŒ' ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
                buttonHtml = `<span class="text-sm text-orange-500 font-medium px-3 py-1 rounded-md bg-orange-100">ìš”ì²­ë°›ìŒ</span>`; 
            } else {
                // 4. ê´€ê³„ê°€ ì—†ëŠ” ê²½ìš° (ìš”ì²­ ë²„íŠ¼ í‘œì‹œ)
                buttonHtml = `<button data-uid="${user.firebase_uid}" 
                                    data-nickname="${user.nickname}"
                                    class="send-friend-request-btn text-sm text-white bg-orange-500 hover:bg-orange-600 px-3 py-1 rounded-md">
                                ì¹œêµ¬ ìš”ì²­
                            </button>`;
            }
            // -----------------------------------------------------------------

            const profileItem = document.createElement('div');
            profileItem.className = "flex items-center justify-between p-2 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors";
            profileItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img class="h-10 w-10 rounded-full object-cover"
                        src="${user.profile_image || defaultProfileImg}" alt="Profile">
                    <span class="font-medium text-gray-700">${user.nickname}</span>
                </div>
                <div class="flex-shrink-0">
                    ${buttonHtml}  </div>
            `;
            return profileItem;
        }
    
        // =========================================================================
        // 3. ì‚¬ìš©ì ê²€ìƒ‰ API í˜¸ì¶œ ë° ê²°ê³¼ ë Œë”ë§ (í•µì‹¬ í•¨ìˆ˜)
        // =========================================================================
        async function searchUsers(query) {
            profileListContainer.innerHTML = ''; 
            profileListContainer.classList.add('hidden');

            if (query.trim().length < 2) {
                profileListContainer.classList.remove('hidden');
                profileListContainer.innerHTML = '<p class="text-sm text-gray-500 p-2">ê²€ìƒ‰ì–´ëŠ” ìµœì†Œ ë‘ ê¸€ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.</p>';
                return;
            }
            
            try {
                //const idToken = await getIdToken(); 
                const token = await currentUser.getIdToken();

                const res = await fetch(`${FASTAPI_BASE_URL}/friends/search?query=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                const data = await res.json();
                const users = data.users || [];
                
                if (users.length > 0) {
                    users.forEach(user => {
                        profileListContainer.appendChild(renderUserSearchResult(user));
                    });
                    profileListContainer.classList.remove('hidden');
                } else {
                    profileListContainer.classList.remove('hidden');
                    profileListContainer.innerHTML = '<p class="text-sm text-gray-500 p-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }

                // ìƒˆë¡œ ë Œë”ë§ëœ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
                attachFriendRequestListeners();

            } catch (error) {
                console.error("ì‚¬ìš©ì ê²€ìƒ‰ ì‹¤íŒ¨:", error);
                profileListContainer.classList.remove('hidden');
                profileListContainer.innerHTML = '<p class="text-sm text-red-500 p-2">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        // =========================================================================
        // 4. ì¹œêµ¬ ìš”ì²­ ì „ì†¡ ë¡œì§ (TODO: ë°±ì—”ë“œ API êµ¬í˜„ ì™„ë£Œ í›„ í™•ì¸ í•„ìš”)
        // =========================================================================
        async function sendFriendRequest(receiverUid, receiverNickname, buttonElement) {
            if (!confirm(`${receiverNickname}ë‹˜ê»˜ ì¹œêµ¬ ìš”ì²­ì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
        //const idToken = await getIdToken();
                const token = await currentUser.getIdToken();

                // POST /friends/request (ì¹œêµ¬ ìš”ì²­ ìƒì„± API) í˜¸ì¶œ
                const res = await fetch(`${FASTAPI_BASE_URL}/friends/request`, { 
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to_user: receiverUid 
                    })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    // 409 Conflict ë“± ì´ë¯¸ ìš”ì²­ì´ ìˆëŠ” ê²½ìš°ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    throw new Error(errorData.detail || `ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨: ${res.status}`);
                }

                // ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
                alert(`${receiverNickname}ë‹˜ê»˜ ì¹œêµ¬ ìš”ì²­ì„ ì„±ê³µì ìœ¼ë¡œ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
                buttonElement.disabled = true;
                // ğŸŒŸ 'ìš”ì²­ ë³´ëƒ„' ëŒ€ì‹  'ìš”ì²­ ì™„ë£Œ'ë¡œ ë³€ê²½í•˜ê³  ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                buttonElement.textContent = 'ìš”ì²­ ì™„ë£Œ'; 
                buttonElement.classList.remove('bg-orange-500', 'hover:bg-orange-600', 'text-white');
                buttonElement.classList.add('bg-gray-100', 'text-gray-500', 'font-medium'); // ìš”ì²­ ì™„ë£Œ ìŠ¤íƒ€ì¼

            } catch (error) {
                console.error("ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨:", error);
                alert(`ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // =========================================================================
        // 5. ë™ì ìœ¼ë¡œ ìƒì„±ëœ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        // =========================================================================
        function attachFriendRequestListeners() {
            // .send-friend-request-btn í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ëª¨ë“  ë²„íŠ¼ì„ ì„ íƒ
            document.querySelectorAll('.send-friend-request-btn').forEach(button => {
                // ì´ë²¤íŠ¸ë¥¼ ì´ë¯¸ ì—°ê²°í–ˆëŠ”ì§€ í™•ì¸í•˜ê³  ì¤‘ë³µì„ ë°©ì§€ (ë§¤ìš° ì¤‘ìš”)
                if (!button.dataset.listenerAttached) {
                    button.addEventListener('click', async (event) => {
                        const btn = event.currentTarget;
                        const receiverUid = btn.getAttribute('data-uid');
                        const receiverNickname = btn.getAttribute('data-nickname');
                        await sendFriendRequest(receiverUid, receiverNickname, btn);
                    });
                    button.dataset.listenerAttached = 'true'; // ì—°ê²° í‘œì‹œ
                }
            });
        }

        // =========================================================================
        // 6. ë©”ì¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (DOM Load í›„ ì‹¤í–‰)
        // =========================================================================
        document.addEventListener('DOMContentLoaded', () => {
            
            // 300ms ë”œë ˆì´ë¥¼ ê°€ì§„ ë””ë°”ìš´ìŠ¤ ê²€ìƒ‰ í•¨ìˆ˜
            const debouncedSearch = debounce(searchUsers, 300);

            // 1. INPUT ì´ë²¤íŠ¸: ì…ë ¥ ì¤‘ ìë™ ê²€ìƒ‰ (debounce ì ìš©)
            if (searchInput) {
                searchInput.addEventListener('input', (event) => {
                    const query = event.target.value;
                    if (query.trim() === '') {
                        profileListContainer.innerHTML = '';
                        profileListContainer.classList.add('hidden');
                    } else {
                        debouncedSearch(query);
                    }
                });
            }

            // 2. SEARCH BUTTON ì´ë²¤íŠ¸: ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ ê²€ìƒ‰
            if (searchButton) {
                searchButton.addEventListener('click', () => {
                    const query = searchInput.value;
                    // ë””ë°”ìš´ìŠ¤ ì—†ì´ ë°”ë¡œ ê²€ìƒ‰ í•¨ìˆ˜ í˜¸ì¶œ
                    searchUsers(query);
                });
            }

            // 3. ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('cancel-add-friend-btn')?.addEventListener('click', () => {
                addFriendModal?.classList.add('hidden');
                // ëª¨ë‹¬ ë‹«ì„ ë•Œ ê²€ìƒ‰ ê²°ê³¼ ë° ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                searchInput.value = '';
                profileListContainer.innerHTML = '';
                profileListContainer.classList.add('hidden');
            });
        });

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                fetchChats(false); // ë¡œê·¸ì¸ í›„ ê¸°ë³¸ íƒ­ (1:1 ì±„íŒ…) ë¡œë“œ
            } else {
                window.location.href = 'index.html';
            }
        });

        // ì±„íŒ… ëª©ë¡ í˜¸ì¶œ ë° ë Œë”ë§
        async function fetchChats(isGroup) {
            if (!currentUser) return;

            const chatType = isGroup ? "ë‹¨ì²´" : "1:1";
            const containerElement = isGroup ? chatListGroup : chatListPrivate;

            containerElement.innerHTML = `<p class="p-4 text-center text-gray-500">ì±„íŒ… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;

            try {
                const token = await currentUser.getIdToken();

                const url = new URL(`${FASTAPI_BASE_URL}/chat/list`);
                url.searchParams.append('is_group', isGroup);

                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 404) {
                    throw new Error('ì‚¬ìš©ì ì¸ì¦ ì‹¤íŒ¨ ë˜ëŠ” API ì˜¤ë¥˜');
                }
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const chats = await response.json();

                await renderGroupedList(containerElement, chats, chatType, isGroup);

            } catch (error) {
                console.error("ì±„íŒ… ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", error);
                containerElement.innerHTML = showEmptyState(chatType, true);
            }
        }

        // ì±„íŒ…ë°© ë‚˜ê°€ê¸° ë¡œì§
        async function leaveChat(roomId) {
            if (!currentUser) return;

            try {
                const token = await currentUser.getIdToken();

                const response = await fetch(`${FASTAPI_BASE_URL}/chat/${roomId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                console.log(`Successfully left chat ${roomId}`);

                // ëª©ë¡ ê°±ì‹ 
                const isGroupActive = tabGroup.classList.contains('tab-active');
                fetchChats(isGroupActive);

            } catch (error) {
                console.error("Error leaving chat: ", error);
                alert(`ì±„íŒ…ë°© ë‚˜ê°€ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        tabPrivate.addEventListener('click', () => {
            chatListPrivate.classList.remove('hidden');
            chatListGroup.classList.add('hidden');

            tabPrivate.classList.replace('tab-inactive', 'tab-active');
            tabGroup.classList.replace('tab-active', 'tab-inactive');

            fetchChats(false); // 1:1 ì±„íŒ… ë¡œë“œ
        });

        tabGroup.addEventListener('click', () => {
            chatListPrivate.classList.add('hidden');
            chatListGroup.classList.remove('hidden');

            tabGroup.classList.replace('tab-inactive', 'tab-active');
            tabPrivate.classList.replace('tab-active', 'tab-inactive');

            fetchChats(true); // ë‹¨ì²´ ì±„íŒ… ë¡œë“œ
        });

        // "ì˜¤ëŠ˜/ì´ì „" ê·¸ë£¹ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        async function renderGroupedList(containerElement, chats, chatType, isGroup) {
            containerElement.innerHTML = '';

            if (chats.length === 0) {
                containerElement.innerHTML = showEmptyState(chatType);
                return;
            }

            const chatsWithDate = chats.map(chat => ({
                ...chat,
                lastUpdatedAt: chat.last_message_timestamp ? new Date(chat.last_message_timestamp) : null
            }));

            chatsWithDate.sort((a, b) => {
                const aTime = a.lastUpdatedAt ? a.lastUpdatedAt.getTime() : 0;
                const bTime = b.lastUpdatedAt ? b.lastUpdatedAt.getTime() : 0;
                return bTime - aTime;
            });

            const todayChats = [];
            const previousChats = [];
            const now = new Date();

            const todayString = now.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                timeZone: 'Asia/Seoul'
            });
            const todayKST = new Date(todayString + ' 00:00:00');

            const today = todayKST;

            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            for (const chat of chatsWithDate) {
                if (chat.lastUpdatedAt) {
                    if (chat.lastUpdatedAt >= today) {
                        todayChats.push(chat);
                    } else {
                        previousChats.push(chat);
                    }
                } else {
                    previousChats.push(chat);
                }
            }

            const ulClass = "bg-white";

            if (todayChats.length > 0) {
                const header = document.createElement('h2');
                header.className = "text-sm font-medium text-gray-500 p-4 pb-2";
                header.textContent = "ì˜¤ëŠ˜ ë°›ì€ ì•Œë¦¼";
                containerElement.appendChild(header);

                const ul = document.createElement('ul');
                ul.className = ulClass;
                for (const chat of todayChats) {
                    ul.appendChild(await createChatItem(chat, isGroup));
                }
                containerElement.appendChild(ul);
            }

            if (previousChats.length > 0) {
                const header = document.createElement('h2');
                header.className = "text-sm font-medium text-gray-500 p-4 pb-2";
                header.textContent = "ì´ì „ ì•Œë¦¼";
                containerElement.appendChild(header);

                const ul = document.createElement('ul');
                ul.className = ulClass;
                for (const chat of previousChats) {
                    ul.appendChild(await createChatItem(chat, isGroup));
                }
                containerElement.appendChild(ul);
            }
        }

        // ê° ì±„íŒ…ë°© ì•„ì´í…œ(li) ìƒì„±
        async function createChatItem(chat, isGroup) {
            let chatName = chat.name || 'ë°¥í’€ì´';
            let profileImageUrl = 'logo_bapick copy.png';

            const unreadCount = 0;

            const li = document.createElement('li');
            li.className = 'chat-list-item relative overflow-hidden border-b last:border-b-0';
            li.dataset.roomId = chat.id;

            const link = document.createElement('a');
            link.href = `/chat.html?roomId=${chat.id}`;
            link.className = 'flex items-center w-full p-4 hover:bg-gray-50';

            const content = document.createElement('div');
            content.className = 'swipeable-content';

            const lastUpdateTime = chat.lastUpdatedAt || null;
            const formattedTime = formatTimestamp(lastUpdateTime);
            const messageContent = chat.last_message_content || 'ëŒ€í™” ë‚´ìš© ì—†ìŒ';

            let nameAndDetailHtml;

            if (isGroup) {
                // ë‹¨ì²´ ì±„íŒ…: ì´ë¦„ + ë©¤ë²„ ìˆ˜ í‘œì‹œ
                nameAndDetailHtml = `
                    <div class="flex items-center space-x-2"> 
                        <p class="font-semibold text-gray-800 truncate">${chatName}</p>
                        <div class="flex items-center space-x-1 text-sm text-gray-500 flex-shrink-0">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M17 21v-2a4 4 0 0 0-3-3.87" /><path d="M7 21v-2a4 4 0 0 1 3-3.87" /><circle cx="12" cy="7" r="4" />
                            </svg>
                            <span>${chat.member_count !== null ? chat.member_count : '?'}</span>
                        </div>
                    </div>
                `;
            } else {
                // 1:1 ì±„íŒ…: ì´ë¦„ë§Œ í‘œì‹œ
                nameAndDetailHtml = `<p class="font-semibold text-gray-800 truncate">${chatName}</p>`;
            }


            content.innerHTML = `
                <a href="chat.html?roomId=${chat.id}" class="flex items-center p-4 hover:bg-gray-100 transition-colors border-b border-gray-100">
                    <img class="h-14 w-14 rounded-full object-cover flex-shrink-0" src="${profileImageUrl}" alt="Profile">
                    <div class="ml-4 flex-1 overflow-hidden">
                        ${nameAndDetailHtml}
                        <p class="text-sm text-gray-500 truncate mt-0.5">${messageContent}</p>
                    </div>
                    <div class="flex flex-col items-end space-y-1.5 flex-shrink-0 ml-2 w-16 text-right">
                        <span class="text-xs text-gray-400">${formattedTime}</span>
                        ${unreadCount > 0
                    ? `<span class="bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">${unreadCount > 9 ? '9+' : unreadCount}</span>`
                    : '<div class="w-5 h-5"></div>'
                }
                    </div>
                </a>
            `;

            // 'ë‚˜ê°€ê¸°' ë²„íŠ¼
            const action = document.createElement('div');
            action.className = 'swipe-action bg-red-500 flex items-center justify-center';
            action.innerHTML = `
                <button class="leave-chat-btn text-white font-medium" data-room-id="${chat.id}" data-chat-name="${chatName}">
                    ë‚˜ê°€ê¸°
                </button>
            `;

            li.appendChild(action);
            li.appendChild(content);

            // ë‚˜ê°€ê¸° ë²„íŠ¼ ìŠ¤ì™€ì´í”„ (Hammer.js ì ìš©)
            const hammer = new Hammer(content);
            const swipeThreshold = -80;

            hammer.on('pan', (ev) => {
                document.querySelectorAll('.swipeable-content').forEach(otherContent => {
                    if (otherContent !== content) {
                        otherContent.style.transition = 'transform 0.2s ease-out';
                        otherContent.style.transform = 'translateX(0px)';
                    }
                });

                let newX = ev.deltaX;
                if (newX > 0) newX = 0;
                if (newX < swipeThreshold) newX = swipeThreshold;

                content.style.transition = 'none';
                content.style.transform = `translateX(${newX}px)`;
            });

            hammer.on('panend', (ev) => {
                content.style.transition = 'transform 0.2s ease-out';
                if (ev.deltaX < (swipeThreshold / 2)) {
                    content.style.transform = `translateX(${swipeThreshold}px)`;
                } else {
                    content.style.transform = 'translateX(0px)';
                }
            });

            return li;
        }

        // ë¹ˆ í™”ë©´ í‘œì‹œ
        function showEmptyState(chatType = "ì±„íŒ…", isError = false) {
            const typeText = chatType === "1:1" ? "1:1 ì±„íŒ…" : "ë‹¨ì²´ ì±„íŒ…";
            const message = isError
                ? `ì±„íŒ… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`
                : `ì°¸ì—¬ ì¤‘ì¸ ${typeText}ì´ ì—†ìŠµë‹ˆë‹¤.`;
            const subMessage = isError
                ? `ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.`
                : `ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.`;

            return `
                <div class="h-full flex flex-col items-center justify-center text-center p-4 mt-16">
                    <div class="bg-gray-200 p-5 rounded-full mb-4 inline-block">
                        <svg class="w-12 h-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <h2 class="mt-2 text-lg font-medium text-gray-900">${message}</h2>
                    <p class="mt-1 text-sm text-gray-500">${subMessage}</p>
                </div>`;
        }

        // ì±„íŒ… ì „ì†¡ ì‹œê° í¬ë§·
        function formatTimestamp(dateObj) {
            if (!(dateObj instanceof Date) || isNaN(dateObj.getTime())) return '';

            const date = dateObj;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            if (date >= today) {
                return date.toLocaleTimeString('ko-KR', { hour: 'numeric', minute: '2-digit', hour12: true });
            } else if (date >= yesterday) {
                return 'ì–´ì œ';
            } else {
                return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
            }
        }

        // 'ë‚˜ê°€ê¸°' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('main-content').addEventListener('click', async (e) => {
            if (e.target.classList.contains('leave-chat-btn')) {
                e.preventDefault();
                e.stopPropagation();

                const roomId = e.target.dataset.roomId;
                const chatName = e.target.dataset.chatName;

                if (confirm(`'${chatName}' ì±„íŒ…ë°©ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? (ë°©ì´ ì‚­ì œë©ë‹ˆë‹¤)`)) {
                    await leaveChat(roomId);
                }
            }
        });

        // í•˜ë‹¨ ë©”ë‰´ë°” '+' ë²„íŠ¼ ê¸°ëŠ¥
        function closeAllPopups() {
            overlay.classList.add('hidden');
            addChatPopup.classList.remove('popup-visible');
            addChatPopup.classList.add('popup-hidden');
        }

        addChatBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            const isOpen = addChatPopup.classList.contains('popup-visible');
            closeAllPopups();
            if (!isOpen) {
                overlay.classList.remove('hidden');
                addChatPopup.classList.remove('popup-hidden');
                addChatPopup.classList.add('popup-visible');
            }
        });
        overlay.addEventListener('click', closeAllPopups);


        // í—¤ë” ê²€ìƒ‰ì°½ ê¸°ëŠ¥
        searchBtn.addEventListener('click', () => {
            headerMain.classList.add('hidden');
            headerSearch.classList.remove('hidden');
            headerSearch.classList.add('flex');
            chatSearchInput.focus();
        });

        cancelSearchBtn.addEventListener('click', () => {
            headerMain.classList.remove('hidden');
            headerSearch.classList.add('hidden');
            headerSearch.classList.remove('flex');
            chatSearchInput.value = '';

            document.querySelectorAll('#main-content li').forEach(item => {
                item.style.display = '';
            });
        });

        chatSearchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            document.querySelectorAll('#main-content li.chat-list-item').forEach(item => {
                const chatNameEl = item.querySelector('p.font-semibold');
                if (chatNameEl) {
                    const chatName = chatNameEl.textContent.toLowerCase();
                    if (chatName.includes(term)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                }
            });
        });
        // ... (ê¸°ì¡´ ë³€ìˆ˜ ë° ì¸ì¦ ì½”ë“œ) ...

        const friendRequestList = document.getElementById('friend-request-list');
        const noRequestsText = document.getElementById('no-requests-text');

        // 7. ë°›ì€ ì¹œêµ¬ ìš”ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
        async function loadFriendRequests() {
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            friendRequestList.innerHTML = '<p class="text-sm text-gray-500 p-2 text-center">ìš”ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            if (!currentUser) return; // ë¡œê·¸ì¸ í™•ì¸

            try {
                const token = await currentUser.getIdToken();
                const res = await fetch(`${FASTAPI_BASE_URL}/friends/requests`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();
                const requests = data.requests || [];

                friendRequestList.innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì‚­ì œ
                
                if (requests.length === 0) {
                    noRequestsText.classList.remove('hidden');
                    friendRequestList.appendChild(noRequestsText);
                } else {
                    noRequestsText.classList.add('hidden');
                    requests.forEach(req => {
                        friendRequestList.appendChild(renderFriendRequest(req));
                    });
                }
                attachRequestHandleListeners(); // ìš”ì²­ ì²˜ë¦¬ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì—°ê²°

            } catch (error) {
                console.error("ì¹œêµ¬ ìš”ì²­ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", error);
                friendRequestList.innerHTML = '<p class="text-sm text-red-500 p-2 text-center">ìš”ì²­ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.</p>';
            }
        }

        // 8. ë°›ì€ ì¹œêµ¬ ìš”ì²­ í•­ëª© HTML ë Œë”ë§ (requester_uid ì‚¬ìš©)
        function renderFriendRequest(req) {
            const defaultProfileImg = "https://via.placeholder.com/100?text=Profile";
            const item = document.createElement('div');
            item.className = "flex items-center justify-between p-2 rounded-lg bg-gray-50";
            item.dataset.requesterUid = req.from_user_uid; // ìš”ì²­ ë³´ë‚¸ ì‚¬ëŒì˜ UID ì €ì¥

            item.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img class="h-10 w-10 rounded-full object-cover"
                        src="${req.from_user_profile_image || defaultProfileImg}" alt="Profile">
                    <span class="font-medium text-gray-700">${req.from_user_nickname}</span>
                </div>
                <div class="space-x-2 flex-shrink-0">
                    <button data-action="accept" data-requester-uid="${req.from_user_uid}" 
                            class="handle-request-btn text-sm text-white bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded-md">ìˆ˜ë½</button>
                    <button data-action="reject" data-requester-uid="${req.from_user_uid}"
                            class="handle-request-btn text-sm text-white bg-red-500 hover:bg-red-600 px-3 py-1 rounded-md">ê±°ì ˆ</button>
                </div>
            `;
            return item;
        }

        // 9. ìš”ì²­ ì²˜ë¦¬ API í˜¸ì¶œ ë° UI ì—…ë°ì´íŠ¸ (requester_uid ì‚¬ìš©)
        async function handleFriendRequest(requesterUid, action, buttonElement) {
            if (!currentUser) return;
            
            buttonElement.disabled = true;
            buttonElement.textContent = 'ì²˜ë¦¬ ì¤‘...';

            try {
                const token = await currentUser.getIdToken();
                const res = await fetch(`${FASTAPI_BASE_URL}/friends/handle`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        requester_uid: requesterUid, // request_id ëŒ€ì‹  requester_uid ì „ì†¡
                        action: action 
                    })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.detail || `ìš”ì²­ ì²˜ë¦¬ ì‹¤íŒ¨: ${res.status}`);
                }
                
                alert(action === 'accept' ? 'ì¹œêµ¬ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.');
                
                // ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ë©´ í•´ë‹¹ ìš”ì²­ í•­ëª©ì„ ëª©ë¡ì—ì„œ ì œê±°
                const listItem = buttonElement.closest(`div[data-requester-uid="${requesterUid}"]`);
                if (listItem) {
                    listItem.remove();
                }
                // ìš”ì²­ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ìµœì‹  ìƒíƒœ ë°˜ì˜
                loadFriendRequests(); 

            } catch (error) {
                console.error(`ìš”ì²­ ì²˜ë¦¬ ì‹¤íŒ¨ (${action}):`, error);
                alert(`ìš”ì²­ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
                buttonElement.disabled = false;
                buttonElement.textContent = action === 'accept' ? 'ìˆ˜ë½' : 'ê±°ì ˆ';
            }
        }

        // 10. ìš”ì²­ ì²˜ë¦¬ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° (requester_uid ì‚¬ìš©)
        function attachRequestHandleListeners() {
            document.querySelectorAll('.handle-request-btn').forEach(button => {
                if (!button.dataset.listenerAttached) {
                    button.addEventListener('click', async (event) => {
                        const btn = event.currentTarget;
                        const requesterUid = btn.getAttribute('data-requester-uid'); // data-requester-uid ì†ì„± ì‚¬ìš©
                        const action = btn.getAttribute('data-action');
                        await handleFriendRequest(requesterUid, action, btn);
                    });
                    button.dataset.listenerAttached = 'true';
                }
            });
        }
    </script>
</body>

</html>
