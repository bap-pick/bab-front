<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>밥픽</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #ffffff;
        }
        .bg-custom-point { background-color: #FF7242 !important; }
        .hover-bg-custom-point:hover { background-color: #FF7242 !important; }
        .border-custom-today { border-color: #FF7242 !important; }

        /* 오버레이 */
        #overlay {
            transition: opacity 0.3s ease-in-out;
        }

        /* 사이드 메뉴 애니메이션 */
        #side-menu {
            opacity: 0;
            transform: scale(0.95) translateX(-10px);
            transform-origin: top left;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }
        #side-menu.open {
            opacity: 1;
            transform: scale(1) translateX(0);
            pointer-events: auto;
        }
        
        /* Custom scrollbar hiding utility */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* Scroll Snap Utilities */
        .scroll-snap-y-mandatory {
            scroll-snap-type: y mandatory;
        }
        .scroll-snap-align-center {
            scroll-snap-align: center;
        }

        /* Swipe action styles */
        .swipe-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
        }
        .swipe-content {
            position: relative;
            z-index: 10;
            transition: transform 0.3s ease;
            touch-action: pan-y; /* 수직 스크롤 우선 */
            background-color: #F9E9CC;
        }
        .swipe-actions {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 160px; /* 80px per button */
            display: flex;
            z-index: 1;
        }
        .action-button {
            height: 100%;
            width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-white">
    <!-- 모든 팝업을 위한 공용 배경 -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-20 z-40 hidden"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50 pointer-events-none">
        <p id="toast-message"></p>
    </div>

    <!-- 타원형 사이드 메뉴 -->
    <aside id="side-menu" class="fixed top-[88px] left-4 bg-[#F9E9CC] shadow-lg z-50 p-2 flex flex-col rounded-full">
        <nav>
            <ul class="flex flex-col items-center space-y-2">
                <li>
                    <a href="chat_list.html" class="flex items-center justify-center w-12 h-12 rounded-full text-[#2A2C41] hover:bg-[#FDBF50]/60">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center justify-center w-12 h-12 rounded-full bg-[#FDBF50] text-[#2A2C41]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center justify-center w-12 h-12 rounded-full text-[#2A2C41] hover:bg-[#FDBF50]/60">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center justify-center w-12 h-12 rounded-full text-[#2A2C41] hover:bg-[#FDBF50]/60">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <div class="h-full flex flex-col">
        <!-- 상단 헤더 -->
        <header class="grid grid-cols-3 items-center p-4 border-b border-gray-200">
            <div>
                <button id="menu-btn" class="text-gray-500 hover:text-gray-800 transition-colors duration-200 z-50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>
            <h1 class="text-xl font-bold text-center">캘린더</h1>
            <div class="justify-self-end">
                <!-- 오른쪽 아이콘 제거됨 -->
            </div>
        </header>

        <!-- 메인 컨텐츠 (스크롤 가능) -->
        <main class="flex-1 overflow-y-auto">
            <div class="max-w-lg mx-auto p-4">
                <!-- 달력 컨테이너 -->
                <div class="flex flex-col items-center">
                    <div class="flex items-center justify-between w-full mb-4">
                        <button id="monthYearBtn" class="text-lg font-semibold cursor-pointer p-2 rounded-md hover:bg-gray-100 transition-colors duration-200"></button>
                        <div class="flex space-x-2">
                            <button id="prevMonth" class="text-gray-500 p-2 rounded-full hover:bg-gray-200 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <button id="nextMonth" class="text-gray-500 p-2 rounded-full hover:bg-gray-200 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- 요일 표시 -->
                    <div class="grid grid-cols-7 text-center text-sm font-medium text-gray-400 w-full">
                        <span>일</span>
                        <span>월</span>
                        <span>화</span>
                        <span>수</span>
                        <span>목</span>
                        <span>금</span>
                        <span>토</span>
                    </div>

                    <!-- 날짜 그리드 -->
                    <div id="calendarGrid" class="grid grid-cols-7 justify-items-center w-full mt-2 gap-y-2">
                        <!-- 날짜 셀은 JS로 채워집니다 -->
                    </div>
                </div>
            
                <!-- 구분선 추가 -->
                <hr class="w-full my-6 border-gray-300">

                <!-- 예약 현황 섹션 -->
                <div class="space-y-4">
                    <h2 class="text-lg font-bold">예약 현황</h2>
                    <div id="reservationsContainer" class="space-y-4">
                        <!-- 예약 카드는 JS로 채워집니다 -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 예약 추가 버튼 -->
    <button id="add-reservation-btn" class="fixed bottom-6 right-6 bg-[#FF7242] hover:bg-orange-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg transition-transform transform hover:scale-110 z-30">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>

    <!-- 년/월 선택 모달창 -->
    <div id="monthYearModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-xs">
            <h3 class="text-lg font-bold mb-4 text-center">년도 및 월 선택</h3>
            <div class="flex justify-between items-center">
                <button id="prevYear" class="text-gray-500 hover:bg-gray-200 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <span id="modalYear" class="font-bold"></span>
                <button id="nextYear" class="text-gray-500 hover:bg-gray-200 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            <div id="monthSelector" class="grid grid-cols-3 gap-2 mt-4">
                <!-- 월 버튼은 JS로 채워집니다 -->
            </div>
        </div>
    </div>
    
    <!-- 예약 추가/수정 Bottom Sheet Modal -->
    <div id="reservation-modal" class="fixed inset-0 z-50 hidden flex justify-center items-end pointer-events-none">
        <div id="bottom-sheet" class="bg-white w-full max-w-lg rounded-t-2xl p-4 transition-transform duration-300 ease-in-out transform translate-y-full pointer-events-auto">
            <!-- 상단 핸들 -->
            <div class="w-full flex justify-center mb-4">
                <div class="w-10 h-1 bg-gray-300 rounded-full"></div>
            </div>

            <!-- 예약 날짜 표시 -->
            <h3 id="reservation-date-title" class="text-xl font-bold text-center mb-6"></h3>
            
            <!-- 식당 이름 검색 버튼 -->
            <div class="mb-6">
                <label class="font-semibold mb-3 text-gray-700 block">식당 이름</label>
                <button id="open-search-modal-btn" class="w-full p-3 border border-gray-300 rounded-lg text-left text-gray-500 hover:bg-gray-50 transition">
                    식당을 검색해주세요
                </button>
            </div>

            <!-- 시간 선택 (Time Picker) -->
            <div class="mb-6">
                <p class="font-semibold mb-3 text-gray-700">시간</p>
                <div class="h-40 relative flex justify-center items-center gap-4 overflow-hidden">
                    <!-- 선택 인디케이터 -->
                    <div class="absolute inset-x-0 h-10 top-1/2 -translate-y-1/2 bg-gray-100 rounded-lg z-0"></div>
                    <!-- 시간 컬럼 -->
                    <div id="hours-selector" class="h-full overflow-y-scroll scroll-snap-y-mandatory scrollbar-hide text-2xl font-medium text-gray-700">
                        <!-- JS로 채워짐 -->
                    </div>
                    <span class="text-2xl font-semibold text-gray-700">:</span>
                    <!-- 분 컬럼 -->
                    <div id="minutes-selector" class="h-full overflow-y-scroll scroll-snap-y-mandatory scrollbar-hide text-2xl font-medium text-gray-700">
                        <!-- JS로 채워짐 -->
                    </div>
                </div>
            </div>

            <!-- 인원 선택 -->
            <div class="mb-8">
                <p class="font-semibold mb-3 text-gray-700">인원</p>
                <div id="people-selector" class="grid grid-cols-6 gap-3">
                     <!-- 인원 버튼은 JS로 생성 -->
                </div>
            </div>

            <!-- 예약 완료/수정 완료 버튼 -->
            <button id="confirm-reservation-btn" class="w-full bg-custom-point text-white font-bold py-4 rounded-xl hover:bg-orange-600 transition-colors duration-200">
                예약 완료
            </button>
        </div>
    </div>
    
    <!-- 식당 검색 모달 -->
    <div id="restaurant-search-modal" class="fixed inset-0 bg-white z-[60] transform translate-y-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <!-- 검색 모달 헤더 -->
            <header class="flex items-center p-4 border-b border-gray-200">
                <button id="close-search-modal-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-lg font-bold text-center flex-1">식당 검색</h2>
                <div class="w-6"></div> <!-- 오른쪽 공간 맞춤용 -->
            </header>
            <!-- 검색 입력 필드 -->
            <div class="p-4 border-b border-gray-200">
                <input type="search" id="restaurant-search-input" placeholder="식당 이름으로 검색" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent transition">
            </div>
            <!-- 검색 결과 목록 -->
            <main id="search-results-container" class="flex-1 overflow-y-auto p-4">
                <!-- JS로 채워짐 -->
            </main>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const currentMonthYearEl = document.getElementById('monthYearBtn');
            const calendarGridEl = document.getElementById('calendarGrid');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            const reservationsContainer = document.getElementById('reservationsContainer');
            
            // Modals and Overlays
            const monthYearModal = document.getElementById('monthYearModal');
            const monthSelector = document.getElementById('monthSelector');
            const prevYearBtn = document.getElementById('prevYear');
            const nextYearBtn = document.getElementById('nextYear');
            const modalYearEl = document.getElementById('modalYear');
            const menuBtn = document.getElementById('menu-btn');
            const sideMenu = document.getElementById('side-menu');
            const overlay = document.getElementById('overlay');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            // Reservation Modal Elements
            const addReservationBtn = document.getElementById('add-reservation-btn');
            const reservationModal = document.getElementById('reservation-modal');
            const bottomSheet = document.getElementById('bottom-sheet');
            const reservationDateTitle = document.getElementById('reservation-date-title');
            const openSearchModalBtn = document.getElementById('open-search-modal-btn');
            const peopleSelector = document.getElementById('people-selector');
            const confirmReservationBtn = document.getElementById('confirm-reservation-btn');

            // Search Modal Elements
            const restaurantSearchModal = document.getElementById('restaurant-search-modal');
            const closeSearchModalBtn = document.getElementById('close-search-modal-btn');
            const restaurantSearchInput = document.getElementById('restaurant-search-input');
            const searchResultsContainer = document.getElementById('search-results-container');


            // State
            let currentDate = new Date();
            let selectedDate = null;
            let selectedRestaurant = null;
            let toastTimeout;
            let editingReservationIndex = null;
            const mockReservations = [];
            const mockRestaurants = [
                { name: '가나다 식당', address: '서울 강남구' },
                { name: '강남 불백', address: '서울 강남구' },
                { name: '브루클린 더 버거 조인트', address: '서울 서초구' },
                { name: '피자 익스프레스', address: '서울 용산구' },
                { name: '을밀대', address: '서울 마포구' }
            ];

            // --- Calendar Functions ---
            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                currentMonthYearEl.textContent = `${year}년 ${month + 1}월`;
                calendarGridEl.innerHTML = '';
                const firstDay = new Date(year, month, 1).getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();
                const today = new Date();

                for (let i = 0; i < firstDay; i++) {
                    calendarGridEl.appendChild(document.createElement('div'));
                }

                for (let date = 1; date <= lastDate; date++) {
                    const dayCell = document.createElement('button');
                    dayCell.textContent = date;
                    dayCell.classList.add('w-10', 'h-10', 'flex', 'items-center', 'justify-center', 'rounded-full', 'transition-colors', 'duration-200', 'text-gray-800');

                    if (selectedDate && date === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) {
                        dayCell.classList.add('bg-custom-point', 'text-white');
                    }
                    
                    if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        dayCell.classList.add('border', 'border-custom-today');
                    }
                    
                    dayCell.addEventListener('click', () => {
                        selectedDate = new Date(year, month, date);
                        renderCalendar();
                        renderReservations(selectedDate);
                    });
                    calendarGridEl.appendChild(dayCell);
                }
            };

            const renderReservations = (date) => {
                reservationsContainer.innerHTML = '';
                if (!date) {
                    reservationsContainer.className = 'flex items-center justify-center min-h-[100px]';
                    reservationsContainer.innerHTML = `<p class="text-center text-gray-500">날짜를 선택하여 예약 현황을 확인하세요.</p>`;
                    return;
                }
                const reservations = mockReservations.filter(r => new Date(r.date).toDateString() === date.toDateString());

                if (reservations.length > 0) {
                    reservationsContainer.className = 'space-y-4';
                    reservations.forEach((reservation, index) => {
                        const swipeContainer = document.createElement('div');
                        swipeContainer.className = 'swipe-container';

                        const swipeActions = document.createElement('div');
                        swipeActions.className = 'swipe-actions';

                        // Edit Button
                        const editButton = document.createElement('button');
                        editButton.className = 'action-button';
                        editButton.style.backgroundColor = '#6b7280'; // gray-500
                        editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg><span>수정</span>`;
                        editButton.onclick = () => openReservationModalForEdit(index);

                        // Delete Button
                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'action-button';
                        deleteButton.style.backgroundColor = '#ef4444'; // red-500
                        deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg><span>삭제</span>`;
                        deleteButton.onclick = () => {
                            mockReservations.splice(index, 1);
                             swipeContainer.style.transition = 'all 0.3s ease';
                             swipeContainer.style.height = '0px';
                             swipeContainer.style.opacity = '0';
                             swipeContainer.style.padding = '0';
                             swipeContainer.style.margin = '0';
                             setTimeout(() => renderReservations(selectedDate), 300);
                        };

                        swipeActions.appendChild(editButton);
                        swipeActions.appendChild(deleteButton);
                        
                        const reservationCard = document.createElement('div');
                        reservationCard.className = 'swipe-content p-4 shadow-md flex items-center space-x-4';
                        
                        reservationCard.innerHTML = `
                            <div class="rounded-lg w-12 h-12 flex items-center justify-center text-white font-bold text-xl" style="background-color: #FDBF50;">${new Date(reservation.date).getDate()}</div>
                            <div class="flex-1 text-gray-800">
                                <p class="text-lg font-semibold">${reservation.restaurant}</p>
                                <p class="text-sm font-medium mt-1">${reservation.time} / ${reservation.people}</p>
                            </div>`;

                        swipeContainer.appendChild(swipeActions);
                        swipeContainer.appendChild(reservationCard);
                        reservationsContainer.appendChild(swipeContainer);
                        
                        addSwipeListeners(reservationCard);
                    });
                } else {
                    reservationsContainer.className = 'flex items-center justify-center min-h-[100px]';
                    reservationsContainer.innerHTML = `<p class="text-center text-gray-500">선택한 날짜에 예약이 없습니다.</p>`;
                }
            };

            const renderMonthModal = () => {
                const year = currentDate.getFullYear();
                modalYearEl.textContent = year;
                monthSelector.innerHTML = '';
                const monthNames = ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"];
                monthNames.forEach((name, index) => {
                    const monthButton = document.createElement('button');
                    monthButton.textContent = name;
                    monthButton.classList.add('p-2', 'rounded-lg', 'transition-colors', 'duration-200', 'hover-bg-custom-point', 'hover:text-white', 'font-medium');
                    if (currentDate.getMonth() === index) {
                        monthButton.classList.add('bg-custom-point', 'text-white');
                    }
                    monthButton.addEventListener('click', () => {
                        currentDate.setMonth(index);
                        monthYearModal.classList.add('hidden');
                        renderCalendar();
                    });
                    monthSelector.appendChild(monthButton);
                });
            };
            
            // --- UI Helper Functions ---
            const showToast = (message) => {
                clearTimeout(toastTimeout);
                toastMessage.textContent = message;
                toast.classList.remove('opacity-0');
                toastTimeout = setTimeout(() => {
                    toast.classList.add('opacity-0');
                }, 2000);
            }

            // --- Side Menu Functions ---
            const closeSideMenu = () => {
                sideMenu.classList.remove('open');
                overlay.classList.add('hidden');
            };

            // --- Reservation Modal Functions ---
            const _openBottomSheetUI = () => {
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                reservationDateTitle.textContent = selectedDate.toLocaleString('ko-KR', options);

                overlay.classList.remove('hidden');
                reservationModal.classList.remove('hidden');
                setTimeout(() => {
                    bottomSheet.classList.remove('translate-y-full');
                }, 10);
            };

            const openReservationModalForCreate = () => {
                if (!selectedDate) {
                    showToast('날짜를 먼저 선택해주세요.');
                    return;
                }
                editingReservationIndex = null;
                confirmReservationBtn.textContent = '예약 완료';

                selectedRestaurant = null;
                openSearchModalBtn.textContent = '식당을 검색해주세요';
                openSearchModalBtn.classList.add('text-gray-500');
                openSearchModalBtn.classList.remove('text-gray-800', 'font-semibold');
                
                populateTimePicker();
                populatePeopleCount();
                
                _openBottomSheetUI();
            };
            
            const openReservationModalForEdit = (index) => {
                const reservation = mockReservations[index];
                if (!reservation) return;

                editingReservationIndex = index;
                confirmReservationBtn.textContent = '수정 완료';

                selectedDate = new Date(reservation.date);
                selectedRestaurant = { name: reservation.restaurant, address: '' }; 

                openSearchModalBtn.textContent = reservation.restaurant;
                openSearchModalBtn.classList.remove('text-gray-500');
                openSearchModalBtn.classList.add('text-gray-800', 'font-semibold');

                populateTimePicker();
                populatePeopleCount();
                
                peopleSelector.querySelectorAll('button').forEach(btn => {
                    if (btn.textContent === reservation.people) {
                        handleSelection(peopleSelector, btn);
                    }
                });

                _openBottomSheetUI();

                setTimeout(() => {
                    const [hour, minute] = reservation.time.split(':');
                    const itemHeight = 40;
                    document.getElementById('hours-selector').scrollTop = parseInt(hour, 10) * itemHeight;
                    document.getElementById('minutes-selector').scrollTop = (parseInt(minute, 10) / 5) * itemHeight;
                }, 100);
            };

            const closeReservationModal = () => {
                bottomSheet.classList.add('translate-y-full');
                setTimeout(() => {
                    reservationModal.classList.add('hidden');
                    if (!sideMenu.classList.contains('open')) {
                         overlay.classList.add('hidden');
                    }
                }, 300);
            };
            
            // --- Search Modal Functions ---
            const openSearchModal = () => {
                restaurantSearchModal.classList.remove('translate-y-full');
            };
            
            const closeSearchModal = () => {
                restaurantSearchModal.classList.add('translate-y-full');
            };

            const renderSearchResults = (query = '') => {
                searchResultsContainer.innerHTML = '';
                const filtered = mockRestaurants.filter(r => r.name.includes(query));

                if (filtered.length === 0) {
                    searchResultsContainer.innerHTML = `<p class="text-center text-gray-500">검색 결과가 없습니다.</p>`;
                    return;
                }

                filtered.forEach(restaurant => {
                    const resultItem = document.createElement('button');
                    resultItem.className = 'w-full text-left p-4 hover:bg-gray-100 rounded-lg';
                    resultItem.innerHTML = `
                        <p class="font-semibold text-gray-800">${restaurant.name}</p>
                        <p class="text-sm text-gray-500">${restaurant.address}</p>
                    `;
                    resultItem.addEventListener('click', () => {
                        selectedRestaurant = restaurant;
                        openSearchModalBtn.textContent = restaurant.name;
                        openSearchModalBtn.classList.remove('text-gray-500');
                        openSearchModalBtn.classList.add('text-gray-800', 'font-semibold');
                        closeSearchModal();
                    });
                    searchResultsContainer.appendChild(resultItem);
                });
            };

            // --- Swipe to Delete Functions ---
            let swipeState = {
                startX: 0,
                currentX: 0,
                isDragging: false,
                swipedElement: null
            };

            function addSwipeListeners(element) {
                element.addEventListener('mousedown', (e) => handleSwipeStart(e, element));
                element.addEventListener('touchstart', (e) => handleSwipeStart(e, element));
                
                element.addEventListener('mousemove', (e) => handleSwipeMove(e, element));
                element.addEventListener('touchmove', (e) => handleSwipeMove(e, element));

                element.addEventListener('mouseup', () => handleSwipeEnd(element));
                element.addEventListener('mouseleave', () => handleSwipeEnd(element));
                element.addEventListener('touchend', () => handleSwipeEnd(element));
            }

            function handleSwipeStart(e, element) {
                if (swipeState.swipedElement && swipeState.swipedElement !== element) {
                    swipeState.swipedElement.style.transform = 'translateX(0)';
                }
                swipeState.swipedElement = element;
                swipeState.startX = e.pageX || e.touches[0].pageX;
                swipeState.isDragging = true;
                element.style.transition = 'none';
            }

            function handleSwipeMove(e, element) {
                if (!swipeState.isDragging || swipeState.swipedElement !== element) return;
                swipeState.currentX = e.pageX || e.touches[0].pageX;
                let deltaX = swipeState.currentX - swipeState.startX;
                if (deltaX > 0) deltaX = 0; 
                if (deltaX < -170) deltaX = -170; // Max swipe distance
                element.style.transform = `translateX(${deltaX}px)`;
            }

            function handleSwipeEnd(element) {
                if (!swipeState.isDragging || swipeState.swipedElement !== element) return;
                
                swipeState.isDragging = false;
                element.style.transition = 'transform 0.3s ease';
                const deltaX = swipeState.currentX - swipeState.startX;
                const threshold = -60;

                if (deltaX < threshold) {
                    element.style.transform = `translateX(-160px)`; // Reveal width
                } else {
                    element.style.transform = 'translateX(0)';
                    swipeState.swipedElement = null;
                }
                swipeState.startX = 0;
            }

            const populateTimePicker = () => {
                const hoursSelector = document.getElementById('hours-selector');
                const minutesSelector = document.getElementById('minutes-selector');
                hoursSelector.innerHTML = '';
                minutesSelector.innerHTML = '';

                const itemHeight = 40;
                const paddingElHeight = `calc(50% - ${itemHeight / 2}px)`;

                const createPadding = () => {
                    const padding = document.createElement('div');
                    padding.style.height = paddingElHeight;
                    return padding;
                };
                
                hoursSelector.appendChild(createPadding());
                for (let i = 0; i <= 23; i++) {
                    const hour = document.createElement('div');
                    hour.textContent = i.toString().padStart(2, '0');
                    hour.className = 'h-10 flex items-center justify-center scroll-snap-align-center transition-all duration-200 opacity-50';
                    hoursSelector.appendChild(hour);
                }
                hoursSelector.appendChild(createPadding());

                minutesSelector.appendChild(createPadding());
                for (let i = 0; i < 60; i += 5) {
                    const minute = document.createElement('div');
                    minute.textContent = i.toString().padStart(2, '0');
                    minute.className = 'h-10 flex items-center justify-center scroll-snap-align-center transition-all duration-200 opacity-50';
                    minutesSelector.appendChild(minute);
                }
                minutesSelector.appendChild(createPadding());

                const updateActive = (container) => {
                    const centerIndex = Math.round(container.scrollTop / itemHeight);
                    Array.from(container.children).forEach((child, index) => {
                        const itemIndex = index - 1; 
                        if (itemIndex === centerIndex) {
                            child.classList.remove('opacity-50', 'scale-90');
                            child.classList.add('opacity-100', 'scale-100', 'font-bold');
                        } else {
                            child.classList.add('opacity-50', 'scale-90');
                            child.classList.remove('opacity-100', 'scale-100', 'font-bold');
                        }
                    });
                };

                let scrollTimeout;
                hoursSelector.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => updateActive(hoursSelector), 150);
                });
                minutesSelector.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => updateActive(minutesSelector), 150);
                });
                
                 setTimeout(() => {
                    updateActive(hoursSelector);
                    updateActive(minutesSelector);
                }, 50);
            };


            const populatePeopleCount = () => {
                peopleSelector.innerHTML = '';
                for (let i = 1; i <= 6; i++) {
                    const button = document.createElement('button');
                    button.textContent = `${i}명`;
                    button.className = 'p-3 rounded-lg font-medium transition-colors bg-gray-100 hover:bg-gray-200';
                    button.addEventListener('click', () => handleSelection(peopleSelector, button));
                    peopleSelector.appendChild(button);
                }
            };
            
            const handleSelection = (container, clickedButton) => {
                container.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('bg-custom-point', 'text-white');
                    btn.classList.add('bg-gray-100');
                });
                clickedButton.classList.add('bg-custom-point', 'text-white');
                clickedButton.classList.remove('bg-gray-100');
            };

            const getSelectedTime = () => {
                const hoursSelector = document.getElementById('hours-selector');
                const minutesSelector = document.getElementById('minutes-selector');
                const itemHeight = 40;

                const hourIndex = Math.round(hoursSelector.scrollTop / itemHeight);
                const minuteIndex = Math.round(minutesSelector.scrollTop / itemHeight);

                const selectedHour = hourIndex.toString().padStart(2, '0');
                const selectedMinute = (minuteIndex * 5).toString().padStart(2, '0');

                return `${selectedHour}:${selectedMinute}`;
            };


            // --- Event Listeners ---
            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (sideMenu.classList.contains('open')) {
                    closeSideMenu();
                } else {
                    closeReservationModal();
                    sideMenu.classList.add('open');
                    overlay.classList.remove('hidden');
                }
            });

            overlay.addEventListener('click', () => {
                closeSideMenu();
                closeReservationModal();
            });

            currentMonthYearEl.addEventListener('click', () => {
                renderMonthModal();
                monthYearModal.classList.remove('hidden');
            });
            monthYearModal.addEventListener('click', (e) => {
                if (e.target === monthYearModal) monthYearModal.classList.add('hidden');
            });
            prevYearBtn.addEventListener('click', () => {
                currentDate.setFullYear(currentDate.getFullYear() - 1);
                renderMonthModal();
            });
            nextYearBtn.addEventListener('click', () => {
                currentDate.setFullYear(currentDate.getFullYear() + 1);
                renderMonthModal();
            });
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            addReservationBtn.addEventListener('click', openReservationModalForCreate);
            
            // Reservation Modal events
            reservationModal.addEventListener('click', (e) => {
                if (e.target === reservationModal) closeReservationModal();
            });
            
            openSearchModalBtn.addEventListener('click', () => {
                renderSearchResults();
                openSearchModal();
            });

            confirmReservationBtn.addEventListener('click', () => {
                if (!selectedRestaurant) {
                    showToast('식당을 선택해주세요.');
                    return;
                }
                const selectedTime = getSelectedTime();
                const selectedPeopleEl = peopleSelector.querySelector('.bg-custom-point');
                if(!selectedPeopleEl) {
                    showToast('인원을 선택해주세요.');
                    return;
                }
                const selectedPeople = selectedPeopleEl.textContent;

                const reservationData = {
                    date: selectedDate.toISOString(),
                    time: selectedTime,
                    people: selectedPeople,
                    restaurant: selectedRestaurant.name
                };

                if (editingReservationIndex !== null) {
                    mockReservations[editingReservationIndex] = reservationData;
                    showToast(`'${selectedRestaurant.name}' 예약 수정 완료!`);
                } else {
                    mockReservations.push(reservationData);
                    showToast(`'${selectedRestaurant.name}' 예약 완료!`);
                }
                
                editingReservationIndex = null;
                renderReservations(selectedDate);
                closeReservationModal();
            });
            
            // Search Modal events
            closeSearchModalBtn.addEventListener('click', closeSearchModal);
            restaurantSearchInput.addEventListener('input', (e) => {
                renderSearchResults(e.target.value);
            });

            // Initial Render
            renderCalendar();
            renderReservations(null);
        });
    </script>
</body>
</html>

