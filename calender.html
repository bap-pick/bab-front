<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>밥픽 - 캘린더</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #ffffff;
            padding-bottom: 80px; /* 하단 바와 버튼 공간 확보 */
        }
        .bg-custom-point { background-color: #FF7242 !important; }
        .text-custom-point { color: #FF7242 !important; }
        .border-custom-today { border-color: #FF7242 !important; }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .scroll-snap-y-mandatory { scroll-snap-type: y mandatory; }
        .scroll-snap-align-center { scroll-snap-align: center; }

        .swipe-container { position: relative; overflow: hidden; border-radius: 0.75rem; }
        .swipe-content { position: relative; z-index: 10; transition: transform 0.3s ease; touch-action: pan-y; background-color: #F9E9CC; }
        .swipe-actions { position: absolute; top: 0; right: 0; bottom: 0; width: 160px; display: flex; z-index: 1; }
        .action-button { height: 100%; width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 500; }
        
        /* 팝업 애니메이션 */
        .popup-hidden {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
            transition: all 0.2s ease-out;
            pointer-events: none;
        }
        .popup-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            transition: all 0.2s ease-in;
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-white">
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-20 z-40 hidden transition-opacity duration-300"></div>
    
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-[70] pointer-events-none">
        <p id="toast-message"></p>
    </div>

    <div class="h-full flex flex-col">
        <header class="grid grid-cols-3 items-center p-4 border-b border-gray-200">
            <div></div>
            <h1 class="text-xl font-bold text-center">캘린더</h1>
            <div class="justify-self-end"></div>
        </header>

        <main class="flex-1 overflow-y-auto">
            <div class="max-w-lg mx-auto p-4">
                <div class="flex flex-col items-center">
                    <div class="flex items-center justify-between w-full mb-4">
                        <button id="monthYearBtn" class="text-lg font-semibold cursor-pointer p-2 rounded-md hover:bg-gray-100"></button>
                        <div class="flex space-x-2">
                            <button id="prevMonth" class="text-gray-500 p-2 rounded-full hover:bg-gray-200"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                            <button id="nextMonth" class="text-gray-500 p-2 rounded-full hover:bg-gray-200"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 text-center text-sm font-medium text-gray-400 w-full">
                        <span>일</span><span>월</span><span>화</span><span>수</span><span>목</span><span>금</span><span>토</span>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 justify-items-center w-full mt-2 gap-y-2"></div>
                </div>
                <hr class="w-full my-6 border-gray-300">
                <div class="space-y-4">
                    <h2 class="text-lg font-bold">예약 현황</h2>
                    <div id="reservationsContainer" class="space-y-4"></div>
                    <button id="add-reservation-btn" class="w-full flex items-center justify-center p-3 mt-4 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        <span>새 예약 추가</span>
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <div id="monthYearModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-xs">
            <h3 class="text-lg font-bold mb-4 text-center">년도 및 월 선택</h3>
            <div class="flex justify-between items-center">
                <button id="prevYear" class="text-gray-500 hover:bg-gray-200 p-2 rounded-full"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <span id="modalYear" class="font-bold"></span>
                <button id="nextYear" class="text-gray-500 hover:bg-gray-200 p-2 rounded-full"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></button>
            </div>
            <div id="monthSelector" class="grid grid-cols-3 gap-2 mt-4"></div>
        </div>
    </div>
    
    <div id="reservation-modal" class="fixed inset-0 z-50 hidden flex justify-center items-end pointer-events-none">
        <div id="bottom-sheet" class="bg-white w-full max-w-lg rounded-t-2xl p-4 transition-transform duration-300 ease-in-out transform translate-y-full pointer-events-auto">
            <div class="w-full flex justify-center mb-4"><div class="w-10 h-1 bg-gray-300 rounded-full"></div></div>
            <h3 id="reservation-date-title" class="text-xl font-bold text-center mb-6"></h3>
            <div class="mb-6">
                <label class="font-semibold mb-3 text-gray-700 block">식당 이름</label>
                <button id="open-search-modal-btn" class="w-full p-3 border border-gray-300 rounded-lg text-left text-gray-500 hover:bg-gray-50 transition">식당을 검색해주세요</button>
            </div>
            <div class="mb-6">
                <p class="font-semibold mb-3 text-gray-700">시간</p>
                <div class="h-40 relative flex justify-center items-center gap-4 overflow-hidden">
                    <div class="absolute inset-x-0 h-10 top-1/2 -translate-y-1/2 bg-gray-100 rounded-lg z-0"></div>
                    <div id="hours-selector" class="h-full overflow-y-scroll scroll-snap-y-mandatory scrollbar-hide text-2xl font-medium text-gray-700"></div>
                    <span class="text-2xl font-semibold text-gray-700 z-10">:</span>
                    <div id="minutes-selector" class="h-full overflow-y-scroll scroll-snap-y-mandatory scrollbar-hide text-2xl font-medium text-gray-700"></div>
                </div>
            </div>
            <div class="mb-8">
                <p class="font-semibold mb-3 text-gray-700">인원</p>
                <div id="people-selector" class="grid grid-cols-6 gap-3"></div>
            </div>
            <button id="confirm-reservation-btn" class="w-full bg-custom-point text-white font-bold py-4 rounded-xl hover:bg-orange-600">저장</button>
        </div>
    </div>
    
    <div id="restaurant-search-modal" class="fixed inset-0 bg-white z-[60] transform translate-y-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <header class="flex items-center p-4 border-b border-gray-200">
                <button id="close-search-modal-btn"><svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-lg font-bold text-center flex-1">식당 검색</h2>
                <div class="w-6"></div>
            </header>
            <div class="p-4 border-b border-gray-200">
                <input type="search" id="restaurant-search-input" placeholder="식당 이름으로 검색" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400">
            </div>
            <main id="search-results-container" class="flex-1 overflow-y-auto p-4"></main>
        </div>
    </div>

    <div id="add-chat-popup" class="absolute bottom-24 left-1/2 -translate-x-1/2 w-48 bg-white rounded-md shadow-xl z-50 popup-hidden">
        <div class="py-2">
            <a href="chat_list.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
                채팅 목록
            </a>
            <a href="chat.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                1:1 채팅방
            </a>
            <a href="chat_group.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><path d="M18 21v-2a4 4 0 0 0-4-4h-1"/><circle cx="9" cy="7" r="4"/><path d="M18 7h3a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1h-3"/><path d="m15.5 13.5-3-3 3-3"/></svg>
                단체 채팅방
            </a>
        </div>
    </div>

    <footer class="fixed bottom-0 left-0 right-0 z-30">
        <nav class="flex justify-around items-center h-16 bg-white rounded-t-2xl shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
            <a href="home.html" class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span class="mt-1">홈</span>
            </a>
            <a href="#" class="flex flex-col items-center justify-center w-1/5 h-full text-[#FF7242] text-xs">
                 <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                 <span class="font-bold mt-1">캘린더</span>
            </a>
            <div class="w-1/5"></div>
            <a href="scrap.index.html" class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
               <span class="mt-1">스크랩</span>
            </a>
            <a href="mypage.index.html" class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span class="mt-1">마이</span>
            </a>
        </nav>
    </footer>

    <button id="add-chat-btn" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-16 h-16 bg-[#FF7242] hover:bg-orange-600 text-white rounded-full flex items-center justify-center shadow-lg z-40">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>
    <a href="chat.html" id="secondary-action-btn"
        class="fixed bottom-20 right-6 w-16 h-16 bg-[#FFF6E2] hover:bg-orange-600 text-white rounded-full flex items-center justify-center shadow-lg transition-transform transform hover:scale-110 z-40"
        style="background-image: url('logo_bapick.png'); background-size: 132%; background-repeat: no-repeat; background-position: center 0.5%;">
    </a>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 상수 선언 ---
        const overlay = document.getElementById('overlay');
        const addChatBtn = document.getElementById('add-chat-btn');
        const addChatPopup = document.getElementById('add-chat-popup');
        const addReservationBtn = document.getElementById('add-reservation-btn');
        const currentMonthYearEl = document.getElementById('monthYearBtn');
        const calendarGridEl = document.getElementById('calendarGrid');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const reservationsContainer = document.getElementById('reservationsContainer');
        const monthYearModal = document.getElementById('monthYearModal');
        const monthSelector = document.getElementById('monthSelector');
        const prevYearBtn = document.getElementById('prevYear');
        const nextYearBtn = document.getElementById('nextYear');
        const modalYearEl = document.getElementById('modalYear');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const reservationModal = document.getElementById('reservation-modal');
        const bottomSheet = document.getElementById('bottom-sheet');
        const reservationDateTitle = document.getElementById('reservation-date-title');
        const openSearchModalBtn = document.getElementById('open-search-modal-btn');
        const peopleSelector = document.getElementById('people-selector');
        const confirmReservationBtn = document.getElementById('confirm-reservation-btn');
        const restaurantSearchModal = document.getElementById('restaurant-search-modal');
        const closeSearchModalBtn = document.getElementById('close-search-modal-btn');
        const restaurantSearchInput = document.getElementById('restaurant-search-input');
        const searchResultsContainer = document.getElementById('search-results-container');
        
        let currentDate = new Date();
        let selectedDate = null;
        let selectedRestaurant = null;
        let toastTimeout;
        let editingReservationIndex = null;
        const mockReservations = [];
        const mockRestaurants = [
            { name: '가나다 식당', address: '서울 강남구' },
            { name: '강남 불백', address: '서울 강남구' },
            { name: '브루클린 더 버거 조인트', address: '서울 서초구' }
        ];

        const closeAllPopups = () => {
            overlay.classList.add('hidden');
            addChatPopup.classList.remove('popup-visible');
            addChatPopup.classList.add('popup-hidden');
            monthYearModal.classList.add('hidden');
            closeReservationModal();
        };

        const renderCalendar = () => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            currentMonthYearEl.textContent = `${year}년 ${month + 1}월`;
            calendarGridEl.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            for (let i = 0; i < firstDay; i++) { calendarGridEl.appendChild(document.createElement('div')); }
            for (let date = 1; date <= lastDate; date++) {
                const dayCell = document.createElement('button');
                dayCell.textContent = date;
                dayCell.className = 'w-10 h-10 flex items-center justify-center rounded-full transition-colors text-gray-800';
                if (selectedDate && date === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) {
                    dayCell.classList.add('bg-custom-point', 'text-white');
                }
                if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayCell.classList.add('border', 'border-custom-today');
                }
                 if (!dayCell.classList.contains('bg-custom-point')) {
                    dayCell.classList.add('hover:bg-gray-100');
                }
                dayCell.addEventListener('click', () => {
                    selectedDate = new Date(year, month, date);
                    renderCalendar();
                    renderReservations(selectedDate);
                });
                calendarGridEl.appendChild(dayCell);
            }
        };

        const renderReservations = (date) => {
            reservationsContainer.innerHTML = '';
            if (!date) {
                reservationsContainer.className = 'flex items-center justify-center min-h-[100px]';
                reservationsContainer.innerHTML = `<p class="text-center text-gray-500">날짜를 선택하여 예약 현황을 확인하세요.</p>`;
                return;
            }
            const reservations = mockReservations.filter(r => new Date(r.date).toDateString() === date.toDateString());
            if (reservations.length > 0) {
                reservationsContainer.className = 'space-y-4';
                reservations.forEach((reservation, index) => {
                    const swipeContainer = document.createElement('div');
                    swipeContainer.className = 'swipe-container';
                    const swipeActions = document.createElement('div');
                    swipeActions.className = 'swipe-actions';
                    const editButton = document.createElement('button');
                    editButton.className = 'action-button';
                    editButton.style.backgroundColor = '#6b7280';
                    editButton.innerHTML = `<svg class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg><span>수정</span>`;
                    editButton.onclick = () => openReservationModalForEdit(index);
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'action-button';
                    deleteButton.style.backgroundColor = '#ef4444';
                    deleteButton.innerHTML = `<svg class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg><span>삭제</span>`;
                    deleteButton.onclick = () => {
                        mockReservations.splice(index, 1);
                        swipeContainer.style.transition = 'all 0.3s ease';
                        swipeContainer.style.height = '0px';
                        swipeContainer.style.opacity = '0';
                        swipeContainer.style.padding = '0';
                        swipeContainer.style.margin = '0';
                        setTimeout(() => renderReservations(selectedDate), 300);
                    };
                    swipeActions.appendChild(editButton);
                    swipeActions.appendChild(deleteButton);
                    const reservationCard = document.createElement('div');
                    reservationCard.className = 'swipe-content p-4 shadow-md flex items-center space-x-4';
                    reservationCard.innerHTML = `
                        <div class="rounded-lg w-12 h-12 flex items-center justify-center text-white font-bold text-xl" style="background-color: #FDBF50;">${new Date(reservation.date).getDate()}</div>
                        <div class="flex-1 text-gray-800">
                            <p class="text-lg font-semibold">${reservation.restaurant}</p>
                            <p class="text-sm font-medium mt-1">${reservation.time} / ${reservation.people}</p>
                        </div>`;
                    swipeContainer.appendChild(swipeActions);
                    swipeContainer.appendChild(reservationCard);
                    reservationsContainer.appendChild(swipeContainer);
                    addSwipeListeners(reservationCard);
                });
            } else {
                reservationsContainer.className = 'flex items-center justify-center min-h-[100px]';
                reservationsContainer.innerHTML = `<p class="text-center text-gray-500">선택한 날짜에 예약이 없습니다.</p>`;
            }
        };

        const renderMonthModal = () => {
            const year = currentDate.getFullYear();
            modalYearEl.textContent = year;
            monthSelector.innerHTML = '';
            const monthNames = ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"];
            monthNames.forEach((name, index) => {
                const monthButton = document.createElement('button');
                monthButton.textContent = name;
                monthButton.className = 'p-2 rounded-lg transition-colors hover-bg-custom-point hover:text-white font-medium';
                if (currentDate.getMonth() === index) { monthButton.classList.add('bg-custom-point', 'text-white'); }
                monthButton.addEventListener('click', () => {
                    currentDate.setMonth(index);
                    monthYearModal.classList.add('hidden');
                    renderCalendar();
                });
                monthSelector.appendChild(monthButton);
            });
        };
        
        const showToast = (message) => {
            clearTimeout(toastTimeout);
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0');
            toastTimeout = setTimeout(() => { toast.classList.add('opacity-0'); }, 2000);
        }

        const closeReservationModal = () => {
            bottomSheet.classList.add('translate-y-full');
            setTimeout(() => {
                reservationModal.classList.add('hidden');
                if (!addChatPopup.classList.contains('popup-visible')) {
                     overlay.classList.add('hidden');
                }
            }, 300);
        };
        
        const _openBottomSheetUI = () => {
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            reservationDateTitle.textContent = selectedDate.toLocaleString('ko-KR', options);
            overlay.classList.remove('hidden');
            reservationModal.classList.remove('hidden');
            setTimeout(() => { bottomSheet.classList.remove('translate-y-full'); }, 10);
        };
        const openReservationModalForCreate = () => {
            if (!selectedDate) {
                showToast('날짜를 먼저 선택해주세요.');
                return;
            }
            editingReservationIndex = null;
            confirmReservationBtn.textContent = '저장';
            selectedRestaurant = null;
            openSearchModalBtn.textContent = '식당을 검색해주세요';
            openSearchModalBtn.classList.add('text-gray-500');
            openSearchModalBtn.classList.remove('text-gray-800', 'font-semibold');
            populateTimePicker();
            populatePeopleCount();
            _openBottomSheetUI();
        };
        const openReservationModalForEdit = (index) => {
            const reservation = mockReservations[index];
            if (!reservation) return;
            editingReservationIndex = index;
            confirmReservationBtn.textContent = '저장';
            selectedDate = new Date(reservation.date);
            selectedRestaurant = { name: reservation.restaurant, address: '' }; 
            openSearchModalBtn.textContent = reservation.restaurant;
            openSearchModalBtn.classList.remove('text-gray-500');
            openSearchModalBtn.classList.add('text-gray-800', 'font-semibold');
            populateTimePicker();
            populatePeopleCount();
            peopleSelector.querySelectorAll('button').forEach(btn => {
                if (btn.textContent === reservation.people) { handleSelection(peopleSelector, btn); }
            });
            _openBottomSheetUI();
            setTimeout(() => {
                const [hour, minute] = reservation.time.split(':');
                const itemHeight = 40;
                document.getElementById('hours-selector').scrollTop = parseInt(hour, 10) * itemHeight;
                document.getElementById('minutes-selector').scrollTop = (parseInt(minute, 10) / 5) * itemHeight;
            }, 100);
        };
        
        const openSearchModal = () => restaurantSearchModal.classList.remove('translate-y-full');
        const closeSearchModal = () => restaurantSearchModal.classList.add('translate-y-full');
        const renderSearchResults = (query = '') => {
            searchResultsContainer.innerHTML = '';
            const filtered = mockRestaurants.filter(r => r.name.toLowerCase().includes(query.toLowerCase()));
            if (filtered.length === 0) {
                searchResultsContainer.innerHTML = `<p class="text-center text-gray-500">검색 결과가 없습니다.</p>`;
                return;
            }
            filtered.forEach(restaurant => {
                const resultItem = document.createElement('button');
                resultItem.className = 'w-full text-left p-4 hover:bg-gray-100 rounded-lg';
                resultItem.innerHTML = `<p class="font-semibold text-gray-800">${restaurant.name}</p><p class="text-sm text-gray-500">${restaurant.address}</p>`;
                resultItem.addEventListener('click', () => {
                    selectedRestaurant = restaurant;
                    openSearchModalBtn.textContent = restaurant.name;
                    openSearchModalBtn.classList.remove('text-gray-500');
                    openSearchModalBtn.classList.add('text-gray-800', 'font-semibold');
                    closeSearchModal();
                });
                searchResultsContainer.appendChild(resultItem);
            });
        };

        let swipeState = { startX: 0, currentX: 0, isDragging: false, swipedElement: null };
        function addSwipeListeners(element) {
             let startX, currentX = 0, initialTransform = 0;
            const swipeThreshold = 50;
            element.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                initialTransform = parseFloat(element.style.transform.replace('translateX(', '').replace('px)', '') || 0);
                element.style.transition = 'none';
                swipeState.isDragging = true;
                swipeState.swipedElement = element;
                document.querySelectorAll('.swipe-content').forEach(other => {
                    if (other !== element) { other.style.transform = 'translateX(0px)'; other.style.transition = 'transform 0.3s ease'; }
                });
            });
            element.addEventListener('touchmove', (e) => {
                if (!swipeState.isDragging || swipeState.swipedElement !== element) return;
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                const newTransform = Math.max(-160, Math.min(0, diff + initialTransform));
                element.style.transform = `translateX(${newTransform}px)`;
            });
            element.addEventListener('touchend', () => {
                if (!swipeState.isDragging || swipeState.swipedElement !== element) return;
                swipeState.isDragging = false;
                swipeState.swipedElement = null;
                element.style.transition = 'transform 0.3s ease';
                const currentTransform = parseFloat(element.style.transform.replace('translateX(', '').replace('px)', '') || 0);
                if (currentTransform < -swipeThreshold) {
                    element.style.transform = 'translateX(-160px)';
                } else {
                    element.style.transform = 'translateX(0px)';
                }
            });
        }
        
        const populateTimePicker = () => {
            const hoursSelector = document.getElementById('hours-selector');
            const minutesSelector = document.getElementById('minutes-selector');
            hoursSelector.innerHTML = ''; minutesSelector.innerHTML = '';
            const itemHeight = 40;
            const paddingElHeight = `calc(50% - ${itemHeight / 2}px)`;
            const createPadding = () => {
                const padding = document.createElement('div');
                padding.style.height = paddingElHeight;
                return padding;
            };
            hoursSelector.appendChild(createPadding());
            for (let i = 0; i <= 23; i++) {
                const hour = document.createElement('div');
                hour.textContent = i.toString().padStart(2, '0');
                hour.className = 'h-10 flex items-center justify-center scroll-snap-align-center opacity-50';
                hoursSelector.appendChild(hour);
            }
            hoursSelector.appendChild(createPadding());
            minutesSelector.appendChild(createPadding());
            for (let i = 0; i < 60; i += 5) {
                const minute = document.createElement('div');
                minute.textContent = i.toString().padStart(2, '0');
                minute.className = 'h-10 flex items-center justify-center scroll-snap-align-center opacity-50';
                minutesSelector.appendChild(minute);
            }
            minutesSelector.appendChild(createPadding());
            const updateActive = (container) => {
                const centerIndex = Math.round(container.scrollTop / itemHeight);
                Array.from(container.children).forEach((child, index) => {
                    const itemIndex = index - 1; 
                    if (itemIndex === centerIndex) {
                        child.classList.remove('opacity-50', 'scale-90');
                        child.classList.add('opacity-100', 'scale-100', 'font-bold');
                    } else {
                        child.classList.add('opacity-50', 'scale-90');
                        child.classList.remove('opacity-100', 'scale-100', 'font-bold');
                    }
                });
            };
            let scrollTimeout;
            hoursSelector.addEventListener('scroll', () => { clearTimeout(scrollTimeout); scrollTimeout = setTimeout(() => updateActive(hoursSelector), 150); });
            minutesSelector.addEventListener('scroll', () => { clearTimeout(scrollTimeout); scrollTimeout = setTimeout(() => updateActive(minutesSelector), 150); });
            setTimeout(() => { updateActive(hoursSelector); updateActive(minutesSelector); }, 50);
        };

        const populatePeopleCount = () => {
            peopleSelector.innerHTML = '';
            for (let i = 1; i <= 6; i++) {
                const button = document.createElement('button');
                button.textContent = `${i}명`;
                button.className = 'p-3 rounded-lg font-medium bg-gray-100 hover:bg-gray-200';
                button.addEventListener('click', () => handleSelection(peopleSelector, button));
                peopleSelector.appendChild(button);
            }
        };
        
        const handleSelection = (container, clickedButton) => {
            container.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('bg-custom-point', 'text-white');
                btn.classList.add('bg-gray-100');
            });
            clickedButton.classList.add('bg-custom-point', 'text-white');
            clickedButton.classList.remove('bg-gray-100');
        };

        const getSelectedTime = () => {
            const hourIndex = Math.round(document.getElementById('hours-selector').scrollTop / 40);
            const minuteIndex = Math.round(document.getElementById('minutes-selector').scrollTop / 40);
            const selectedHour = hourIndex.toString().padStart(2, '0');
            const selectedMinute = (minuteIndex * 5).toString().padStart(2, '0');
            return `${selectedHour}:${selectedMinute}`;
        };

        // --- 이벤트 리스너 ---
        addChatBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            const isAddChatOpen = addChatPopup.classList.contains('popup-visible');
            closeAllPopups();
            if (!isAddChatOpen) {
                overlay.classList.remove('hidden');
                addChatPopup.classList.remove('popup-hidden');
                addChatPopup.classList.add('popup-visible');
            }
        });
        
        addReservationBtn.addEventListener('click', openReservationModalForCreate);
        overlay.addEventListener('click', closeAllPopups);
        currentMonthYearEl.addEventListener('click', () => { renderMonthModal(); monthYearModal.classList.remove('hidden'); });
        monthYearModal.addEventListener('click', (e) => { if (e.target === monthYearModal) monthYearModal.classList.add('hidden'); });
        prevYearBtn.addEventListener('click', () => { currentDate.setFullYear(currentDate.getFullYear() - 1); renderMonthModal(); });
        nextYearBtn.addEventListener('click', () => { currentDate.setFullYear(currentDate.getFullYear() + 1); renderMonthModal(); });
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        
        reservationModal.addEventListener('click', (e) => { if (e.target === reservationModal) closeReservationModal(); });
        openSearchModalBtn.addEventListener('click', () => { renderSearchResults(); openSearchModal(); });
        closeSearchModalBtn.addEventListener('click', closeSearchModal);
        restaurantSearchInput.addEventListener('input', (e) => renderSearchResults(e.target.value));

        confirmReservationBtn.addEventListener('click', () => {
            if (!selectedRestaurant) { showToast('식당을 선택해주세요.'); return; }
            const selectedTime = getSelectedTime();
            const selectedPeopleEl = peopleSelector.querySelector('.bg-custom-point');
            if(!selectedPeopleEl) { showToast('인원을 선택해주세요.'); return; }
            const selectedPeople = selectedPeopleEl.textContent;
            const reservationData = {
                date: selectedDate.toISOString(),
                time: selectedTime,
                people: selectedPeople,
                restaurant: selectedRestaurant.name
            };
            if (editingReservationIndex !== null) {
                mockReservations[editingReservationIndex] = reservationData;
                showToast(`'${selectedRestaurant.name}' 예약 수정 완료!`);
            } else {
                mockReservations.push(reservationData);
                showToast(`'${selectedRestaurant.name}' 예약 완료!`);
            }
            editingReservationIndex = null;
            renderReservations(selectedDate);
            closeReservationModal();
        });

        // --- 초기 실행 ---
        renderCalendar();
        renderReservations(null);
    });
    </script>
</body>
</html>