<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원정보 수정</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        input[type="radio"]:checked {
            background-color: #FF7A5A;
            border-color: #FF7A5A;
        }
        input[type="radio"]:checked:hover {
            background-color: #FF7A5A;
            border-color: #FF7A5A;
        }
        .bg-custom-point { background-color: #FF7A5A !important; }
        .hover-bg-custom-point:hover { background-color: #FF7A5A !important; color: white !important; }
        .border-custom-point { border-color: #FF7A5A !important; }
    </style>
</head>
<body class="bg-white">

    <div class="h-full flex flex-col">
        
        <header class="grid grid-cols-3 items-center p-4 border-b border-gray-200 flex-shrink-0">
            <div>
                <a href="mypage.index.html" class="text-gray-600 hover:text-gray-900">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 19l-7-7 7-7"/></svg>
                </a>
            </div>
            <h1 class="text-xl font-bold text-center text-gray-800">회원정보 수정</h1>
            <div class="justify-self-end"><div class="w-6 h-6"></div></div>
        </header>

        
        <main class="flex-1 overflow-y-auto bg-white p-6 flex flex-col">
            <div class="space-y-6">
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-500 mb-2">휴대폰 번호</label>
                    <input type="tel" id="phone" class="w-full p-3.5 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF7A5A]" placeholder="010-1234-5678">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-500 mb-2">이메일</label>
                    <input type="email" id="email" class="w-full p-3.5 text-base bg-gray-100 text-gray-500 border border-gray-300 rounded-lg" readonly>
                </div>
                <div>
                    <label for="birthdate" class="block text-sm font-medium text-gray-500 mb-2">생년월일</label>
                    <input type="date" id="birthdate" class="w-full p-3.5 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF7A5A]">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500 mb-3">성별</label>
                    <div class="flex items-center space-x-6">
                        <label class="flex items-center">
                            <input type="radio" name="gender" value="male" class="w-5 h-5 mr-2 border-gray-300 text-[#FF7A5A] focus:ring-[#FF7A5A]">
                            <span class="text-gray-700">남자</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="gender" value="female" class="w-5 h-5 mr-2 border-gray-300 text-[#FF7A5A] focus:ring-[#FF7A5A]">
                            <span class="text-gray-700">여자</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="avoid-food-input" class="block text-sm font-medium text-gray-500 mb-2">먹지 않는 음식</label>
                    <div class="flex space-x-2">
                        <input type="text" id="avoid-food-input" placeholder="예: 고수" class="flex-1 w-full p-3.5 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF7A5A]">
                        <button id="add-food-btn" class="px-5 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">추가</button>
                    </div>
                    <div id="food-tags-container" class="mt-3 flex flex-wrap gap-2"></div>
                </div>
            </div>
            
            <button id="save-info-btn" class="w-full p-4 bg-[#FF7A5A] text-white text-base font-bold rounded-xl cursor-pointer mt-auto disabled:bg-gray-400 transition">저장</button>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

       
        const firebaseConfig = {
          apiKey: "AIzaSyAlmVXljDPwkmi4rik69GLhBIHLskw7P2o",
          authDomain: "bapick-front.firebaseapp.com",
          projectId: "bapick-front",
          storageBucket: "bapick-front.firebasestorage.app",
          messagingSenderId: "883956844611",
          appId: "1:883956844611:web:ac74a589aae30be9d0ecf6",
          measurementId: "G-Z1WEHMPL7F"
        };
        
    
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI 요소 ---
        const phoneInput = document.getElementById('phone');
        const emailInput = document.getElementById('email');
        const birthdateInput = document.getElementById('birthdate');
        const addFoodBtn = document.getElementById('add-food-btn');
        const foodInput = document.getElementById('avoid-food-input');
        const tagsContainer = document.getElementById('food-tags-container');
        const saveInfoBtn = document.getElementById('save-info-btn');

        let currentUser = null;

        // --- 로그인 상태 확인 ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserInfo(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- 사용자 정보 불러오기 ---
        async function loadUserInfo(uid) {
            const userDocRef = doc(db, "users", uid);
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                const userData = docSnap.data();
                phoneInput.value = userData.phoneNumber || '';
                emailInput.value = userData.email || '';
                birthdateInput.value = userData.dateOfBirth || '';
                
                // 성별 라디오 버튼 설정
                if (userData.gender === 'male') {
                    document.querySelector('input[name="gender"][value="male"]').checked = true;
                } else if (userData.gender === 'female') {
                    document.querySelector('input[name="gender"][value="female"]').checked = true;
                }

                // 먹지 않는 음식 태그 생성
                tagsContainer.innerHTML = ''; // 기존 태그 초기화
                if (userData.dislikedFoods && Array.isArray(userData.dislikedFoods)) {
                    userData.dislikedFoods.forEach(food => createTag(food));
                }
            } else {
                console.log("사용자 데이터가 없습니다.");
                emailInput.value = currentUser.email; // 이메일은 Auth에서 가져옴
            }
        }

        // --- '먹지 않는 음식' 태그 관련 함수 ---
        const createTag = (foodName) => {
            const tag = document.createElement('div');
            tag.className = 'flex items-center bg-gray-200 text-gray-800 text-sm font-medium px-3 py-1 rounded-full';
            tag.innerHTML = `<span>${foodName}</span><button class="ml-2 text-gray-500 hover:text-gray-800">&times;</button>`;
            tag.querySelector('button').addEventListener('click', () => tag.remove());
            tagsContainer.appendChild(tag);
        };
        addFoodBtn.addEventListener('click', () => {
            const foodName = foodInput.value.trim();
            if (foodName) {
                createTag(foodName);
                foodInput.value = '';
            }
        });
        foodInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addFoodBtn.click();
            }
        });

        // --- 저장 버튼 클릭 이벤트 ---
        saveInfoBtn.addEventListener('click', async () => {
            if (!currentUser) return;

            // 1. 화면에서 현재 값들 가져오기
            const phoneNumber = phoneInput.value;
            const dateOfBirth = birthdateInput.value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            const dislikedFoods = Array.from(tagsContainer.children).map(tag => tag.querySelector('span').textContent);

            saveInfoBtn.disabled = true;
            saveInfoBtn.textContent = '저장 중...';

            try {
                // 2. Firestore에 저장할 데이터 객체 만들기
                const userDataToSave = {
                    phoneNumber: phoneNumber,
                    dateOfBirth: dateOfBirth,
                    gender: gender,
                    dislikedFoods: dislikedFoods,
                    // 이메일은 보통 변경하지 않으므로 저장하지 않습니다.
                };

                // 3. Firestore에 데이터 업데이트 (merge: true로 다른 필드는 유지)
                const userDocRef = doc(db, "users", currentUser.uid);
                await setDoc(userDocRef, userDataToSave, { merge: true });

                alert('정보가 성공적으로 저장되었습니다!');
                window.location.href = 'mypage.index.html';

            } catch (error) {
                console.error("정보 저장 에러:", error);
                alert('오류가 발생했습니다: ' + error.message);
            } finally {
                saveInfoBtn.disabled = false;
                saveInfoBtn.textContent = '저장';
            }
        });

    </script>
</body>
</html>