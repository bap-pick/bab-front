<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>식당 상세 정보</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=85cfe1eb44a56817dcedc87a46b5070b&libraries=services"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js" defer></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #scrap-btn.scrapped {
            background-color: #FF7A5A;
            color: white;
            border-color: #FF7A5A;
        }

        #scrap-btn.scrapped svg {
            fill: white;
        }

        header.scrolled {
            box-shadow: 0 4px_6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
        }

        .tab-btn.active {
            color: #FF7A5A;
            border-color: #FF7A5A;
        }

        .sheet-visible {
            transform: translateY(0);
        }

        .sheet-hidden {
            transform: translateY(100%);
        }

        .swiper-pagination-bullet-active {
            background-color: #FF7A5A !important;
        }

        .swiper-pagination.swiper-pagination-fraction {
            width: auto;
            left: auto;
            right: 1.25rem;
            bottom: 1.25rem;

            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 12px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 99px;

            z-index: 20;
        }
    </style>
</head>

<!-- 스크랩 버튼 클릭 시 바텀 시트 (컬렉션에 추가) -->
<div id="collection-overlay" class="fixed inset-0 bg-black bg-opacity-30 z-40 hidden transition-opacity duration-300"></div>

<div id="collection-sheet" class="fixed bottom-0 left-0 right-0 z-50 bg-white rounded-t-2xl shadow-xl transition-transform duration-300 ease-in-out transform translate-y-full">
    <div class="p-5 pt-4">
        <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4"></div>
        <h2 class="text-xl font-bold text-center text-gray-800 mb-2">컬렉션에 추가</h2>
        <ul id="sheet-collection-list" class="max-h-60 overflow-y-auto divide-y divide-gray-100"></ul>
        <div class="mt-4 pt-4 border-t border-gray-200">
            <button id="sheet-add-new-btn"
                class="w-full flex items-center justify-center gap-2 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                새 컬렉션 만들기
            </button>
        </div>
    </div>
</div>

<body class="bg-gray-100">
    <div class="max-w-md mx-auto h-full flex flex-col bg-white shadow-lg">

        <header id="page-header"
            class="grid grid-cols-3 items-center p-4 bg-white sticky top-0 z-20 transition-shadow duration-300">
            <div class="justify-self-start">
                <button id="back-button" class="p-2 text-gray-600 hover:bg-gray-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
            </div>
            <h1 id="header-title" class="text-lg font-bold text-center text-gray-800 truncate">식당 정보</h1>
            <div class="justify-self-end w-8"></div>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto">
            <div class="relative w-full h-56">
                <div id="image-swiper" class="swiper h-full">
                    <div class="swiper-wrapper"></div>
                    <div class="swiper-pagination"></div>
                </div>

                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent z-10 pointer-events-none"></div>
            </div>

            <div class="p-5 -mt-10 relative z-10">
                <div class="bg-white rounded-xl shadow-lg p-5">
                    <p id="restaurant-category" class="inline-block bg-orange-100 text-[#FF7A5A] text-sm font-semibold px-3 py-1 rounded-full mb-2">
                        카테고리
                    </p>
                    <h2 id="restaurant-name" class="text-3xl font-bold text-gray-900 leading-tight">식당 이름</h2>
                    <div id="review-info" class="flex items-center gap-4 text-sm text-gray-600 mt-3"></div>
                    <div class="mt-6">
                        <button id="scrap-btn"
                            class="w-full flex items-center justify-center gap-2 py-3 border-2 border-gray-200 bg-white text-gray-700 rounded-lg font-semibold transition-all duration-300 ease-in-out hover:shadow-md transform hover:-translate-y-0.5">
                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.5 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" />
                            </svg>
                            <span>스크랩</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 탭 (상세정보/메뉴/편의시설) -->
            <div class="px-5 border-b border-gray-200">
                <nav class="flex -mb-px">
                    <button class="tab-btn active py-4 px-1 text-center border-b-2 font-medium text-sm flex-1" data-tab="info">
                        상세정보
                    </button>
                    <button class="tab-btn py-4 px-1 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm flex-1" data-tab="menu">
                        메뉴
                    </button>
                    <button class="tab-btn py-4 px-1 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm flex-1" data-tab="facilities">
                        편의시설
                    </button>
                </nav>
            </div>

            <div class="p-5">
                <!-- 식당 상세정보 -->
                <div id="info-panel" class="tab-panel space-y-5">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 text-center">
                            <svg class="w-6 h-6 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">주소</p>
                            <p id="restaurant-address" class="text-gray-600"></p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 text-center">
                            <svg class="w-6 h-6 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">전화번호</p>
                            <p id="restaurant-call" class="text-gray-600"></p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 text-center">
                            <svg class="w-6 h-6 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-700">영업시간</p>
                            <div id="restaurant-time" class="text-gray-600 space-y-1"></div>
                        </div>
                    </div>
                    <!-- 지도 -->
                    <div id="map" class="w-full h-56 rounded-lg border border-gray-200 overflow-hidden mt-4"></div>
                </div>

                <div id="menu-panel" class="tab-panel hidden">
                    <ul id="menu-list" class="space-y-3"></ul>
                </div>
                <div id="facilities-panel" class="tab-panel hidden">
                    <ul id="facilities-list" class="grid grid-cols-2 gap-3"></ul>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "./firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const FASTAPI_BASE_URL = 'https://bab-back.onrender.com';
        //const FASTAPI_BASE_URL = 'http://127.0.0.1:8000'; // 로컬 테스트용

        let currentRestaurant = null;
        let currentUser = null;

        const backButton = document.getElementById('back-button');
        const headerTitle = document.getElementById('header-title');
        const restaurantImageEl = document.getElementById('restaurant-image');
        const restaurantCategoryEl = document.getElementById('restaurant-category');
        const restaurantNameEl = document.getElementById('restaurant-name');
        const scrapBtn = document.getElementById('scrap-btn');
        const reviewInfo = document.getElementById('review-info');
        const restaurantAddressEl = document.getElementById('restaurant-address');
        const restaurantPhoneEl = document.getElementById('restaurant-call');
        const restaurantTimeEl = document.getElementById('restaurant-time');
        const mapContainer = document.getElementById('map');
        const menuListEl = document.getElementById('menu-list');
        const facilitiesListEl = document.getElementById('facilities-list');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.tab-panel');

        const collectionOverlay = document.getElementById('collection-overlay');
        const collectionSheet = document.getElementById('collection-sheet');
        const collectionListEl = document.getElementById('sheet-collection-list');

        // 헤더 스크롤 이벤트 리스너
        document.querySelector('main').addEventListener('scroll', (e) => {
            const header = document.getElementById('page-header');
            if (e.target.scrollTop > 50) {
                header.classList.add('scrolled');
                headerTitle.textContent = restaurantNameEl.textContent;
            } else {
                header.classList.remove('scrolled');
                headerTitle.textContent = '식당 정보';
            }
        });

        // 헤더의 뒤로가기 버튼 이벤트 리스너
        backButton.addEventListener('click', () => {
            history.back();
        });

        // 스크랩 상태에 따라 스크랩 버튼 내 텍스트 업데이트
        function updateScrapButton(isScrapped) {
            if (isScrapped) {
                scrapBtn.classList.add('scrapped');
                scrapBtn.querySelector('span').textContent = '스크랩 완료';
            } else {
                scrapBtn.classList.remove('scrapped');
                scrapBtn.querySelector('span').textContent = '스크랩';
            }
        }

        // 해당 식당의 스크랩 상태 확인
        async function checkScrapStatus() {
            if (!currentUser || !currentRestaurant) return;
            try {
                const idToken = await currentUser.getIdToken(true);
                const response = await fetch(`${FASTAPI_BASE_URL}/scraps/${currentRestaurant.id}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                });
                if (!response.ok) throw new Error('스크랩 상태 조회 실패');
                const { is_scrapped } = await response.json();
                updateScrapButton(is_scrapped);
            } catch (error) {
                console.error('스크랩 상태 확인 실패:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', checkScrapStatus);

        // 스크랩 버튼 클릭 이벤트 리스너
        scrapBtn.addEventListener('click', async () => {
            if (!currentUser) return window.location.href = 'index.html';

            const isScrapped = scrapBtn.classList.contains('scrapped');
            const restaurantId = currentRestaurant.id;

            if (isScrapped) {
                // 1. 이미 스크랩된 경우: 스크랩 버튼을 누르면 스크랩 취소
                try {
                    const idToken = await currentUser.getIdToken(true);
                    const response = await fetch(`${FASTAPI_BASE_URL}/scraps/${restaurantId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${idToken}` }
                    });
                    if (response.ok) {
                        updateScrapButton(false);
                    } else {
                        alert('스크랩 취소 실패');
                    }
                } catch (error) {
                    console.error('스크랩 취소 실패:', error);
                }
            } else {
                // 2. 스크랩이 안 되어있는 경우: '컬렉션 선택' 바텀 시트 열기
                openCollectionSheet();
            }
        });

        // 탭 버튼 이벤트 리스너
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.getAttribute('data-tab');

                // 탭 버튼 활성화/비활성화
                tabButtons.forEach(btn => btn.classList.remove('active', 'border-[#FF7A5A]', 'text-[#FF7A5A]'));
                button.classList.add('active', 'border-[#FF7A5A]', 'text-[#FF7A5A]');
                button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                // 패널 표시/숨김
                tabPanels.forEach(panel => {
                    if (panel.id === `${targetTab}-panel`) {
                        panel.classList.remove('hidden');
                    } else {
                        panel.classList.add('hidden');
                    }
                });
            });
        });

        // 식당 상세 정보 조회 api 호출 및 렌더링
        async function fetchRestaurantDetails(restaurantId, user) {
            if (!user) {
                console.error("fetchRestaurantDetails: User object is null.");
                return null;
            }

            const idToken = await user.getIdToken();

            if (!idToken) {
                window.location.href = 'index.html';
                return null;
            }

            try {
                const response = await fetch(`${FASTAPI_BASE_URL}/restaurants/detail/${restaurantId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.status === 404) {
                    throw new Error("식당 정보를 찾을 수 없습니다.");
                }
                if (!response.ok) {
                    throw new Error(`데이터 조회 오류: ${response.status} ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error("Fetch Error:", error);
                alert(error.message);
                return null;
            }
        }

        /* 식당 정보 렌더링 함수들 (이미지, 리뷰 정보, 메뉴, 편의시설, 운영시간) */
        function renderImage(image) {
            const defalutImages = 'Untitled.png'; // 기본 이미지

            let images = [];

            if (typeof currentRestaurant.image === 'string' && currentRestaurant.image.trim() !== '') {
                images = currentRestaurant.image.split(',').map(url => url.trim());
            } 

            const swiperWrapper = document.querySelector('.swiper-wrapper');
            const swiperContainer = document.querySelector('#image-swiper');

            swiperWrapper.innerHTML = '';

            // 이미지가 1장인 경우
            if (images.length === 1) {
                swiperContainer.classList.remove('swiper');
                swiperWrapper.innerHTML = `
                    <div class="w-full h-full">
                    <img src="${images[0]}" alt="식당 이미지" class="w-full h-full object-cover rounded-xl">
                    </div>
                `;
            // 이미지가 2장 이상인 경우
            } else if (images.length > 1) {
                swiperContainer.classList.add('swiper');
                images.forEach(imageUrl => {
                    const slide = document.createElement('div');
                    slide.className = 'swiper-slide';
                    slide.innerHTML = `<img src="${imageUrl}" alt="식당 이미지" class="w-full h-full object-cover rounded-xl">`;
                    swiperWrapper.appendChild(slide);
            });

            new Swiper('#image-swiper', {
                loop: true,
                pagination: {
                el: '.swiper-pagination',
                type: 'fraction',
                },
            });

            // 가게 이미지가 없는 경우
            } else {
                swiperWrapper.innerHTML = `
                    <div class="w-full h-full">
                    <img src="${defalutImages}" alt="기본 이미지" class="w-full h-full object-cover rounded-xl">
                    </div>
                `;
            }
        }

        function renderReview(reviews) {
            reviewInfo.innerHTML = '';

            if (!reviews || reviews.length === 0) {
                reviewInfo.innerHTML = '';
                return;
            }

            reviewInfo.innerHTML = reviews.map(review => {
                let ratingInfo = '';
                if (review.rating) {
                    ratingInfo = `<div class="flex items-center gap-1">⭐<span class="font-bold">${review.rating}</span></div>`;
                }

                let visitorReviewsInfo = '';
                if (review.visitor_reviews > 0) {
                    visitorReviewsInfo = `<div>방문자 리뷰 <span class="font-semibold">${review.visitor_reviews}</span></div>`;
                }

                let blogReviewsInfo = '';
                if (review.blog_reviews > 0) {
                    blogReviewsInfo = `<div>블로그 리뷰 <span class="font-semibold">${review.blog_reviews}</span></div>`;
                }

                if (!ratingInfo && !visitorReviewsInfo && !blogReviewsInfo) {
                    return '';
                }

                return `
                ${ratingInfo}${visitorReviewsInfo}${blogReviewsInfo}
            `;
            }).join('');
        }

        function renderMenus(menus) {
            menuListEl.innerHTML = '';

            if (!menus || menus.length === 0) {
                menuListEl.innerHTML = '<li class="text-gray-500 p-2 text-center">등록된 메뉴 정보가 없습니다.</li>';
                return;
            }

            menuListEl.innerHTML = menus.map(menu => {
                const menuName = menu.menu_name || menu.name || '';
                const menuPrice = menu.menu_price || menu.price || '';
                return `
                <li class="flex justify-between items-center p-3 bg-white border-b border-gray-100 last:border-b-0">
                    <span class="font-medium text-gray-700">${menuName}</span>
                    <span class="font-medium text-gray-700">${menuPrice}</span>
                </li>
            `;
            }).join('');
        }

        function renderHours(hours) {
            restaurantTimeEl.innerHTML = '';

            if (!hours || hours.length === 0) {
                restaurantTimeEl.innerHTML = '운영 시간 정보가 없습니다.';
                return;
            }

            const dayOrder = ['월', '화', '수', '목', '금', '토', '일'];
            hours.sort((a, b) => dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day));

            restaurantTimeEl.innerHTML = hours.map(hour => {
                let mainTimeInfo = '';
                let additionalInfo = '';

                if (hour.is_closed) {
                    mainTimeInfo = `<span class="text-red-500 font-bold">휴무</span>`;
                } else if (hour.open_time && hour.close_time) {
                    mainTimeInfo = `${hour.open_time.substring(0, 5)} - ${hour.close_time.substring(0, 5)}`;
                } else {
                    mainTimeInfo = '정보 없음';
                }

                let lastOrderInfo = '';
                if (hour.last_order) {
                    lastOrderInfo = ` (라스트 오더: ${hour.last_order.substring(0, 5)})`;
                }

                let breakInfo = '';
                if (hour.break_start && hour.break_end) {
                    breakInfo = `<span class="text-xs text-gray-500">브레이크: ${hour.break_start.substring(0, 5)} - ${hour.break_end.substring(0, 5)}</span>`;
                }

                if (breakInfo) {
                    additionalInfo = `
                    <div class="flex flex-col pt-0.5">
                        ${breakInfo}
                    </div>
                `;
                }

                return `
                <div class="flex flex-col py-1">
                    <div class="flex items-center text-sm gap-4">
                        <span class="font-medium text-gray-700 w-2 flex-shrink-0">${hour.day}</span>
                        <div class="flex-1">
                            <span>${mainTimeInfo}${lastOrderInfo}</span>
                            <span>${additionalInfo}</span>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function renderFacilities(facilities) {
            facilitiesListEl.innerHTML = '';

            if (!facilities || facilities.length === 0) {
                facilitiesListEl.innerHTML = '<li class="col-span-2 text-gray-500 p-2 text-center">등록된 편의시설 정보가 없습니다.</li>';
                return;
            }

            facilitiesListEl.innerHTML = facilities.map(facility => {
                const facilityName = facility.name || '정보 없음';
                return `
                <li class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg text-sm text-gray-700 font-medium">
                    <svg class="w-4 h-4 text-[#FF7A5A] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                    <span>${facilityName}</span>
                </li>
            `;
            }).join('');
        }

        // 해당 식당의 위도/경도를 통해 지도 렌더링 
        function renderMap(lat, lon, name) {
            if (!window.kakao || !window.kakao.maps) {
                console.error("Kakao Map SDK가 로드되지 않았습니다.");
                return;
            }

            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(lat, lon), // 식당 좌표를 지도의 중심으로 설정
                level: 3 // 지도의 확대 레벨
            };

            const map = new kakao.maps.Map(mapContainer, mapOption); // 지도 생성

            // 마커 생성 후 지도에 표시
            const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(lat, lon),
                map: map
            });
        }

        // 메인 함수
        async function loadRestaurantDetails(user) {
            const urlParams = new URLSearchParams(window.location.search);
            const restaurantId = urlParams.get('id');

            if (!restaurantId) {
                document.getElementById('main-content').innerHTML = '<div class="p-4 text-center text-red-500">잘못된 접근입니다: 식당 ID가 없습니다.</div>';
                return;
            }

            const details = await fetchRestaurantDetails(restaurantId, user);
            if (!details) {
                document.getElementById('main-content').innerHTML = '<div class="p-4 text-center text-gray-600">식당 정보를 불러오는 데 실패했습니다.</div>';
                return;
            }

            currentRestaurant = details;

            // 기본 정보 ui 업데이트 (이름, 카테고리, 주소, 전화번호 )
            restaurantNameEl.textContent = currentRestaurant.name || '이름 정보 없음';
            restaurantCategoryEl.textContent = currentRestaurant.category || '카테고리';
            restaurantAddressEl.textContent = currentRestaurant.address || '주소 정보 없음';
            restaurantPhoneEl.textContent = currentRestaurant.phone || '전화번호 정보 없음';

            renderImage(currentRestaurant.image); // 이미지
            renderHours(currentRestaurant.hours); // 운영 시간
            renderReview(currentRestaurant.reviews); // 리뷰
            renderMenus(currentRestaurant.menus); // 메뉴
            renderFacilities(currentRestaurant.facilities); // 편의시설
            // 해당 식당의 지도 (위도/경도 float로 변환)
            renderMap(parseFloat(currentRestaurant.latitude), parseFloat(currentRestaurant.longitude), currentRestaurant.name);
            
            checkScrapStatus(); // 해당 식당의 스크랩 상태 확인
        }

        // 컬렉션 리스트 아이템 생성 및 스크랩 로직 처리
        function createCollectionListItem(collection) {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-4 border-b border-gray-100 last:border-b-0 hover:bg-gray-50 cursor-pointer';

            const isAllScraps = collection.id === 'null';
            const nameClass = isAllScraps
                ? 'font-bold text-orange-500'
                : 'font-medium text-gray-800';

            li.className = 'flex items-center justify-between p-4 border-b border-gray-100 last:border-b-0 hover:bg-gray-50 cursor-pointer';
            li.dataset.collectionId = collection.id; // 컬렉션 ID를 저장
            
            li.innerHTML = `
                <span class="${nameClass}">${collection.name}</span>
                <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
                </svg>
            `;

            // li 클릭 이벤트: 해당 컬렉션으로 스크랩 요청
            li.addEventListener('click', async () => {
                li.classList.add('opacity-50', 'pointer-events-none'); 

                const collectionId = li.dataset.collectionId; 
                
                try {
                    const idToken = await currentUser.getIdToken(true);
                    const restaurantId = currentRestaurant.id;

                    const response = await fetch(`${FASTAPI_BASE_URL}/scraps`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${idToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            restaurant_id: restaurantId,
                            collection_id: collectionId && collectionId !== 'null' ? parseInt(collectionId) : null
                        })
                    });

                    if (response.ok) {
                        updateScrapButton(true); // 스크랩 버튼 UI 업데이트
                        closeCollectionSheet(); // 시트 닫기
                    } else {
                        // 중복 스크랩 등의 서버 응답 처리
                        const result = await response.json();
                        alert(`스크랩 실패: ${result.message || result.detail || '알 수 없는 오류'}`);
                    }
                } catch (error) {
                    console.error('스크랩 요청 실패:', error);
                    alert('스크랩 처리 중 오류가 발생했습니다.');
                } finally {
                    li.classList.remove('opacity-50', 'pointer-events-none');
                }
            });
            return li;
        }

        // 컬렉션 목록을 받아와 바텀 시트에 렌더링하는 함수
        async function fetchAndRenderCollections() {
            const listContainer = document.getElementById('sheet-collection-list');
            listContainer.innerHTML = '<li class="p-3 text-center text-gray-500">컬렉션 목록 불러오는 중...</li>';

            if (!currentUser) {
                listContainer.innerHTML = '<li class="p-3 text-center text-red-500">로그인이 필요합니다.</li>';
                return;
            }

            try {
                const token = await currentUser.getIdToken();
                
                // 1. 사용자 컬렉션 목록 조회 API 호출
                const response = await fetch(`${FASTAPI_BASE_URL}/scraps/collections/me`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('컬렉션 목록 조회 실패');
                
                const userCollections = await response.json();
                
                listContainer.innerHTML = ''; // 기존 로딩 메시지 제거

                // 2. "모든 스크랩" 항목을 목록의 맨 위에 추가 (Collection ID: null)
                listContainer.appendChild(
                    createCollectionListItem({ 
                        id: 'null', 
                        name: '모든 스크랩', 
                    })
                );
                
                // 3. 사용자 정의 컬렉션 목록 렌더링
                userCollections.forEach(collection => {
                    listContainer.appendChild(createCollectionListItem(collection));
                });
                
            } catch (error) {
                console.error('컬렉션 목록 로드 실패:', error);
                listContainer.innerHTML = '<li class="p-3 text-center text-red-500">목록을 불러오지 못했습니다.</li>';
            }
        }

        // 오버레이 클릭 이벤트 리스너: 오버레이(어두운 배경) 클릭 시 바텀 시트 닫기 이벤트 실행
        collectionOverlay.addEventListener('click', closeCollectionSheet);

        // 바텀 시트 open
        function openCollectionSheet() {
            if (!currentUser) {
                alert("로그인이 필요합니다.");
                return;
            }
            
            // 시트가 열릴 때마다 컬렉션 목록을 새로 불러와 렌더링합니다.
            fetchAndRenderCollections();

            collectionOverlay.classList.remove('hidden');
            collectionSheet.classList.add('sheet-visible');
            collectionSheet.classList.remove('translate-y-full');
        }

        // 바텀 시트 close
        function closeCollectionSheet() {
            collectionOverlay.classList.add('hidden');
            collectionSheet.classList.remove('sheet-visible');
            collectionSheet.classList.add('translate-y-full');
        }


        // 로그인 인증
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadRestaurantDetails(user);
            } else {
                window.location.href = 'index.html';
            }
        });

    </script>
</body>
</html>