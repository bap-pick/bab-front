<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>식당 상세 정보</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=jkpav5xenu"></script>
    <style>
        html, body { height: 100%; margin: 0; scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        #scrap-btn.scrapped { background-color: #FF7A5A; color: white; border-color: #FF7A5A; }
        #scrap-btn.scrapped svg { fill: white; }
        header.scrolled { box-shadow: 0 4px_6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07); }
        .tab-btn.active { color: #FF7A5A; border-color: #FF7A5A; }
    </style>
</head>
<body class="bg-gray-100">
    
    <div class="max-w-md mx-auto h-full flex flex-col bg-white shadow-lg">
        
        <header id="page-header" class="grid grid-cols-3 items-center p-4 bg-white sticky top-0 z-20 transition-shadow duration-300">
            <div class="justify-self-start">
                <button id="back-button" class="p-2 text-gray-600 hover:bg-gray-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                </button>
            </div>
            <h1 id="header-title" class="text-lg font-bold text-center text-gray-800 truncate">식당 정보</h1>
            <div class="justify-self-end w-8"></div>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto">
            <div class="relative w-full h-56">
                <img id="restaurant-image" src="https://via.placeholder.com/400x240" alt="식당 대표 이미지" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
            </div>

            <div class="p-5 -mt-10 relative z-10">
                <div class="bg-white rounded-xl shadow-lg p-5">
                    <p id="restaurant-category" class="inline-block bg-orange-100 text-[#FF7A5A] text-sm font-semibold px-3 py-1 rounded-full mb-2">카테고리</p>
                    <h2 id="restaurant-name" class="text-3xl font-bold text-gray-900 leading-tight">식당 이름</h2>
                    
                    <div id="review-info" class="flex items-center gap-4 text-sm text-gray-600 mt-3"></div>

                    <div class="mt-6">
                        <button id="scrap-btn" class="w-full flex items-center justify-center gap-2 py-3 border-2 border-gray-200 bg-white text-gray-700 rounded-lg font-semibold transition-all duration-300 ease-in-out hover:shadow-md transform hover:-translate-y-0.5">
                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.5 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" /></svg>
                            <span>스크랩</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="px-5 border-b border-gray-200">
                <nav class="flex -mb-px">
                    <button class="tab-btn active py-4 px-1 text-center border-b-2 font-medium text-sm flex-1" data-tab="info">상세정보</button>
                    <button class="tab-btn py-4 px-1 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm flex-1" data-tab="menu">메뉴</button>
                    <button class="tab-btn py-4 px-1 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm flex-1" data-tab="facilities">편의시설</button>
                </nav>
            </div>
            
            <div class="p-5">
                <div id="info-panel" class="tab-panel space-y-5">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 text-center">
                            <svg class="w-6 h-6 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">주소</p>
                            <p id="restaurant-address" class="text-gray-600"></p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 text-center">
                            <svg class="w-6 h-6 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">전화번호</p>
                            <p id="restaurant-call" class="text-gray-600"></p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 text-center">
                            <svg class="w-6 h-6 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-700">영업시간</p>
                            <div id="restaurant-time" class="text-gray-600 space-y-1"></div>
                        </div>
                    </div>
                    <div id="map" class="w-full h-56 rounded-lg border border-gray-200 overflow-hidden mt-4"></div>
                </div>
                <div id="menu-panel" class="tab-panel hidden"><ul id="menu-list" class="space-y-3"></ul></div>
                <div id="facilities-panel" class="tab-panel hidden"><ul id="facilities-list" class="grid grid-cols-2 gap-3"></ul></div>
            </div>
        </main>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "./firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const FASTAPI_BASE_URL = 'https://bab-back.onrender.com';
        //const FASTAPI_BASE_URL = 'http://127.0.0.1:8000'; // 로컬 테스트용

        let currentRestaurant = null;
        let currentUser = null;

        const backButton = document.getElementById('back-button');
        const headerTitle = document.getElementById('header-title');
        const restaurantImageEl = document.getElementById('restaurant-image');
        const restaurantCategoryEl = document.getElementById('restaurant-category');
        const restaurantNameEl = document.getElementById('restaurant-name');
        const scrapBtn = document.getElementById('scrap-btn');
        
        // 리뷰 요소
        const reviewInfo = document.getElementById('review-info');
    
        // 상세 정보 패널 요소
        const restaurantAddressEl = document.getElementById('restaurant-address');
        const restaurantPhoneEl = document.getElementById('restaurant-call');
        const restaurantTimeEl = document.getElementById('restaurant-time'); // 영업시간 요소
        const mapContainer = document.getElementById('map');
        
        // 메뉴 리스트 요소
        const menuListEl = document.getElementById('menu-list');
        // 편의시설 리스트 요소
        const facilitiesListEl = document.getElementById('facilities-list');

        // 탭 관련 요소
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.tab-panel');


        // 헤더 스크롤 이벤트 (스크롤 시 헤더 그림자 및 제목 변경)
        document.querySelector('main').addEventListener('scroll', (e) => {
            const header = document.getElementById('page-header');
            if (e.target.scrollTop > 50) {
                header.classList.add('scrolled');
                headerTitle.textContent = restaurantNameEl.textContent;
            } else {
                header.classList.remove('scrolled');
                headerTitle.textContent = '식당 정보';
            }
        });

        // 뒤로가기 버튼
        backButton.addEventListener('click', () => {
            history.back();
        });

        // 지도 로드 함수 (Naver Map API)
        function loadNaverMap(lat, lng, name) {
            if (!window.naver) {
                mapContainer.innerHTML = '<div class="p-4 text-center text-gray-500">지도 SDK 로드 실패.</div>';
                return;
            }
            
            const position = new naver.maps.LatLng(lat, lng);
            const mapOptions = { center: position, zoom: 17, mapTypeControl: true, zoomControl: true };
            const map = new naver.maps.Map(mapContainer, mapOptions);

            const marker = new naver.maps.Marker({ position: position, map: map });

            const infowindow = new naver.maps.InfoWindow({
                content: `<div style="padding:5px; border:1px solid #ccc; border-radius: 5px; background-color: white; font-size:12px;">${name}</div>`,
                anchorSkew: true
            });

            infowindow.open(map, marker);
        }

        // 스크랩 버튼 상태 업데이트 함수
        function updateScrapButton(isScrapped) {
            if (isScrapped) {
                scrapBtn.classList.add('scrapped');
                scrapBtn.querySelector('span').textContent = '스크랩 완료';
            } else {
                scrapBtn.classList.remove('scrapped');
                scrapBtn.querySelector('span').textContent = '스크랩';
            }
        }

        // 스크랩 상태 확인 및 버튼 초기화
        async function checkScrapStatus() {
            if (!currentUser || !currentRestaurant) return;

            try {
                const idToken = await currentUser.getIdToken(true);
                const response = await fetch(`${FASTAPI_BASE_URL}/scraps/${currentRestaurant.id}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                });

                if (!response.ok) throw new Error('스크랩 상태 조회 실패');

                const { is_scrapped } = await response.json();
                updateScrapButton(is_scrapped);
            } catch (error) {
                console.error('스크랩 상태 확인 실패:', error);
            }
        }

        // 페이지 로드 시 상태 확인
        document.addEventListener('DOMContentLoaded', checkScrapStatus);

        // 스크랩 버튼 클릭 처리
        scrapBtn.addEventListener('click', async () => {
            if (!currentUser) return window.location.href = 'index.html';

            try {
                const idToken = await currentUser.getIdToken(true);
                const restaurantId = currentRestaurant.id;
                const isScrapped = scrapBtn.classList.contains('scrapped');

                const url = isScrapped
                    ? `${FASTAPI_BASE_URL}/scraps/${restaurantId}`
                    : `${FASTAPI_BASE_URL}/scraps`;
                const method = isScrapped ? 'DELETE' : 'POST';
                const body = isScrapped ? null : JSON.stringify({ restaurant_id: restaurantId });

                const response = await fetch(url, {
                    method,
                    headers: { 
                        'Authorization': `Bearer ${idToken}`,
                        ...(body ? { 'Content-Type': 'application/json' } : {})
                    },
                    body,
                });

                if (response.ok) {
                    updateScrapButton(!isScrapped);
                } else {
                    alert(isScrapped ? '스크랩 취소 실패' : '스크랩 실패');
                }
            } catch (error) {
                console.error('스크랩 요청 실패:', error);
                alert('스크랩 처리 중 오류가 발생했습니다.');
            }
        });

        // 탭 전환 로직
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.getAttribute('data-tab');
                
                // 탭 버튼 활성화/비활성화
                tabButtons.forEach(btn => btn.classList.remove('active', 'border-[#FF7A5A]', 'text-[#FF7A5A]'));
                button.classList.add('active', 'border-[#FF7A5A]', 'text-[#FF7A5A]');
                button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                // 패널 표시/숨김
                tabPanels.forEach(panel => {
                    if (panel.id === `${targetTab}-panel`) {
                        panel.classList.remove('hidden');
                    } else {
                        panel.classList.add('hidden');
                    }
                });
            });
        });

        // 식당 상세정보 조회 API 호출
        async function fetchRestaurantDetails(restaurantId, user) {
            if (!user) {
                console.error("fetchRestaurantDetails: User object is null.");
                return null;
            }
            
            const idToken = await user.getIdToken(); 

            if (!idToken) {
                window.location.href = 'index.html';
                return null;
            }

            try {
                const response = await fetch(`${FASTAPI_BASE_URL}/restaurants/detail/${restaurantId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.status === 404) {
                    throw new Error("식당 정보를 찾을 수 없습니다.");
                }
                if (!response.ok) {
                    throw new Error(`데이터 조회 오류: ${response.status} ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error("Fetch Error:", error);
                alert(error.message);
                return null;
            }
        }

        // 리뷰 렌더링 
        function renderReview(reviews) {
            reviewInfo.innerHTML = '';

            if (!reviews || reviews.length === 0) {
                reviewInfo.innerHTML = '';
                return;
            }

            reviewInfo.innerHTML = reviews.map(review => {
                let ratingInfo = '';
                if (review.rating) {
                    ratingInfo = `<div class="flex items-center gap-1">⭐<span class="font-bold">${review.rating}</span></div>`;
                }

                let visitorReviewsInfo = '';
                if (review.visitor_reviews > 0) {
                    visitorReviewsInfo = `<div>방문자 리뷰 <span class="font-semibold">${review.visitor_reviews}</span></div>`;
                }

                let blogReviewsInfo = '';
                if (review.blog_reviews > 0) {
                    blogReviewsInfo = `<div>블로그 리뷰 <span class="font-semibold">${review.blog_reviews}</span></div>`;
                }
                
                if (!ratingInfo && !visitorReviewsInfo && !blogReviewsInfo) {
                    return ''; 
                }

                return `
                    ${ratingInfo}${visitorReviewsInfo}${blogReviewsInfo}
                `;
            }).join('');
        }

        // 메뉴 리스트 렌더링
        function renderMenus(menus) {
            menuListEl.innerHTML = ''; 

            if (!menus || menus.length === 0) {
                menuListEl.innerHTML = '<li class="text-gray-500 p-2 text-center">등록된 메뉴 정보가 없습니다.</li>';
                return;
            }
            
            menuListEl.innerHTML = menus.map(menu => {
                const menuName = menu.menu_name || menu.name || '메뉴 이름 없음 (키 불일치)';
                return `
                    <li class="flex justify-between items-center p-3 bg-white border-b border-gray-100 last:border-b-0">
                        <span class="font-medium text-gray-700">${menuName}</span>
                    </li>
                `;
            }).join('');
        }

        // 운영 시간 렌더링
        function renderHours(hours) {
            restaurantTimeEl.innerHTML = '';

            if (!hours || hours.length === 0) {
                restaurantTimeEl.innerHTML = '운영 시간 정보가 없습니다.';
                return;
            }

            const dayOrder = ['월', '화', '수', '목', '금', '토', '일'];
            hours.sort((a, b) => dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day));

            restaurantTimeEl.innerHTML = hours.map(hour => {
                let mainTimeInfo = '';
                let additionalInfo = '';

                // 1. 메인 영업 시간 정보 (시간 또는 휴무)
                if (hour.is_closed) {
                    mainTimeInfo = `<span class="text-red-500 font-bold">휴무</span>`;
                } else if (hour.open_time && hour.close_time) {
                    // 시간 포맷팅은 API 응답 형태에 따라 다를 수 있습니다. (예: "09:00:00" -> "09:00")
                    mainTimeInfo = `${hour.open_time.substring(0, 5)} - ${hour.close_time.substring(0, 5)}`;
                } else {
                    mainTimeInfo = '정보 없음';
                }

                let lastOrderInfo = '';
                if (hour.last_order) {
                    lastOrderInfo = ` (라스트 오더: ${hour.last_order.substring(0, 5)})`;
                }

                let breakInfo = '';
                if (hour.break_start && hour.break_end) {
                    breakInfo = `<span class="text-xs text-gray-500">브레이크: ${hour.break_start.substring(0, 5)} - ${hour.break_end.substring(0, 5)}</span>`;
                }

                if (breakInfo) {
                    additionalInfo = `
                        <div class="flex flex-col pt-0.5">
                            ${breakInfo}
                        </div>
                    `;
                }

                return `
                    <div class="flex flex-col py-1">
                        <div class="flex items-center text-sm gap-4">
                            <span class="font-medium text-gray-700 w-2 flex-shrink-0">${hour.day}</span>
                            <div class="flex-1">
                                <span>${mainTimeInfo}${lastOrderInfo}</span>
                                <span>${additionalInfo}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 편의시설 렌더링
        function renderFacilities(facilities) {
            facilitiesListEl.innerHTML = '';

            if (!facilities || facilities.length === 0) {
                facilitiesListEl.innerHTML = '<li class="col-span-2 text-gray-500 p-2 text-center">등록된 편의시설 정보가 없습니다.</li>';
                return;
            }
            
            facilitiesListEl.innerHTML = facilities.map(facility => {
                const facilityName = facility.name || '정보 없음';
                return `
                    <li class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg text-sm text-gray-700 font-medium">
                        <svg class="w-4 h-4 text-[#FF7A5A] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                        <span>${facilityName}</span>
                    </li>
                `;
            }).join('');
        }

        //인증된 사용자 객체를 받아 데이터를 로드하고 DOM 업데이트
        async function loadRestaurantDetails(user) {
            const urlParams = new URLSearchParams(window.location.search);
            const restaurantId = urlParams.get('id');

            if (!restaurantId) {
                document.getElementById('main-content').innerHTML = '<div class="p-4 text-center text-red-500">잘못된 접근입니다: 식당 ID가 없습니다.</div>';
                return;
            }
            
            // API 호출 (user 객체 전달)
            const details = await fetchRestaurantDetails(restaurantId, user);
            if (!details) {
                document.getElementById('main-content').innerHTML = '<div class="p-4 text-center text-gray-600">식당 정보를 불러오는 데 실패했습니다.</div>';
                return;
            }
            
            currentRestaurant = details;

            // DOM 업데이트
            restaurantNameEl.textContent = currentRestaurant.name || '이름 정보 없음';
            restaurantCategoryEl.textContent = currentRestaurant.category || '카테고리';
            restaurantAddressEl.textContent = currentRestaurant.address || '주소 정보 없음';
            restaurantPhoneEl.textContent = currentRestaurant.phone || '전화번호 정보 없음';
            restaurantImageEl.src = 'https://via.placeholder.com/400x240'; 
            
            // 운영 시간 정보 렌더링
            renderHours(currentRestaurant.hours);

            // 리뷰 정보 렌더링
            renderReview(currentRestaurant.reviews);
            
            // 메뉴 정보 렌더링
            renderMenus(currentRestaurant.menus); 
            
            // 편의시설 정보 렌더링
            renderFacilities(currentRestaurant.facilities);
            
            // 지도 로직
            /*
            if (currentRestaurant.latitude && currentRestaurant.longitude) {
                loadNaverMap(currentRestaurant.latitude, currentRestaurant.longitude, currentRestaurant.name);
            } else {
                mapContainer.innerHTML = '<div class="p-4 text-center text-gray-500">지도 정보를 불러올 수 없습니다.</div>';
            }
            */
            
            // 스크랩 상태 확인
            checkScrapStatus(); 
        }

        // Firebase 인증
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user; 
                loadRestaurantDetails(user);
            } else {
                window.location.href = 'index.html'; 
            }
        });

    </script>
</body>
</html>