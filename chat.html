<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=85cfe1eb44a56817dcedc87a46b5070b&libraries=services,places"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .chat-container {
            width: 100%;
            height: 100vh;
            display: flex; 
            flex-direction: column;
            background-color: #fff;
            box-shadow: none;
            border-radius: 0;
            overflow: hidden;
        }
        .header {
            background-color: #fff;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        .header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #333;
        }
        .chat-area {
            flex-grow: 1; 
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem; 
        }
        .message-box {
            display: flex;
        }
        .message-box.system-message {
            justify-content: flex-start;
            align-items: flex-end;
        }
        .message-box.user-message {
            justify-content: flex-end;
        }
        .profile-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: #6b7280;
            flex-shrink: 0;
            margin-right: 0.75rem;
        }
        .profile-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            line-height: 1.4;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);            
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .message-bubble.system-bubble {
            background-color: #e5e7eb;
            color: #333;
            border-bottom-left-radius: 0.25rem;
            min-height: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center; 
        }
        .message-bubble.user-bubble {
            background-color: #FF7242;
            color: #fff;
            border-bottom-right-radius: 0.25rem;
        }
        .input-area {
            background-color: #fff;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        .input-container {
            position: relative;
            flex-grow: 1;
        }
        .input-area input {
            width: 100%;
            padding: 0.75rem 1.25rem;
            padding-right: 3rem;
            border-radius: 2rem;
            background-color: #f0f2f5;
            border: none;
            outline: none;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .icon-button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* ì‹ë‹¹ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .restaurant-cards-container {
            display: flex;
            flex-direction: row;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            max-width: 100%;
        }
        .restaurant-card {
            width: 240px;
            flex-shrink: 0;
            background-color: #e5e7eb;
            border-radius: 1.25rem;
            text-decoration: none;
        }
        .send-button {
            position: absolute;
            right: 0.25rem;
            top: 50%;
            transform: translateY(-50%);
            background-color: #d1d5db;
            color: #fff;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .send-button.active {
            background-color: #FF7242;
            box-shadow: 0 4px 8px rgba(255, 114, 66, 0.4);
        }
        .send-button .arrow-up {
            transform: rotate(0deg);
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .typing-indicator span {
            width: 6px;
            height: 6px;
            background-color: #999;
            border-radius: 50%;
            display: inline-block;
            animation: blink 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0% { opacity: 0.3; transform: translateY(0); }
            20% { opacity: 1; transform: translateY(-2px); }
            40% { opacity: 0.3; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <header class="header">
            <button class="text-gray-500 hover:text-gray-700" onclick="window.location.href='chat_list.html'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 id="headerTitle">ë°¥í’€ì´</h1>
            <div style="width: 24px; height: 24px;"></div>
        </header>

        <main class="chat-area"></main> 

        <div class="input-area">
            <button id="openFortuneBtn" class="icon-button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
            </button>
            
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onclick="this.focus()">
                <button id="sendButton" class="send-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 arrow-up" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                </button>
            </div>

            <div id="fortuneCookieModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300">
    <div id="fortuneModalContent" class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm relative transform transition-all duration-300 scale-95 opacity-0">
        
        <button id="closeFortuneCookie" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">
            &times;
        </button>

        <h3 class="text-center text-xl font-bold mb-4 text-gray-800">ìš´ëª…ì˜ í¬ì¶˜ ì¿ í‚¤</h3>

        <div id="closedCookieSection" class="flex flex-col items-center">
            <img src="close fortune cookie.png" alt="ë‹«íŒ í¬ì¶˜ ì¿ í‚¤" class="w-40 h-40 mb-6 animate-pulse">
            <button id="openCookieBtn" class="bg-gradient-to-r from-orange-400 to-red-500 text-white font-semibold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-200">
                ì—´ì–´ë³´ê¸°
            </button>
        </div>

        <div id="openedCookieSection" class="hidden flex flex-col items-center text-center">
            <img src="open fortune cookie.png" alt="ì—´ë¦° í¬ì¶˜ ì¿ í‚¤" class="w-40 h-40 mb-4 animate-fadeIn">
            <p id="fortuneMessage" class="text-lg font-semibold text-gray-700 mb-6 leading-relaxed"></p>
            <button id="confirmCookieBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-full hover:bg-gray-300 transition duration-200">
                í™•ì¸
            </button>
        </div>
    </div>
</div>
        </div>
    <script type="module">
    // Firebase SDK import 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { firebaseConfig } from "./firebase-config.js";

    // Firebase ì•± ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    // FastAPI ì„œë²„ URL
    //const FASTAPI_BASE_URL = 'http://127.0.0.1:8000'; // ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©
    const FASTAPI_BASE_URL = "https://bab-back.onrender.com"; 
    
    // JSON ì‘ë‹µ 
    marked.setOptions({ breaks: true, gfm: true});

    // ì „ì—­ ë³€ìˆ˜
    let idToken = null;
    let currentUserUid = null;
    let currentRoomId = null;
    let isCreatingRoom = false;
    let currentChatroomIsGroup = false;
    const fortuneCookieModal = document.getElementById('fortuneCookieModal'); 
    const openCookieBtnInModal = document.getElementById('openCookieBtn'); 
    const closedCookieSection = document.getElementById('closedCookieSection');
    const openedCookieSection = document.getElementById('openedCookieSection');
    const fortuneMessage = document.getElementById('fortuneMessage');
    const closeFortuneCookieBtn = document.getElementById('closeFortuneCookie');
    const confirmCookieBtn = document.getElementById('confirmCookieBtn');
    const modalContent = document.getElementById('fortuneModalContent');
    const defaultProfileImg = "https://bit.ly/3K2rlSh"; // í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•˜ì§€ ì•Šì€ ê²½ìš°
    let chatbotProfileImg = 'logo_bapick copy.png'; 
    const greetingMessage = "ì•ˆë…•! ë‚˜ëŠ” ì˜¤ëŠ˜ì˜ ìš´ì„¸ì— ë§ì¶° í–‰ìš´ì˜ ë§›ì§‘ì„ ì¶”ì²œí•´ì£¼ëŠ” 'ë°¥í’€ì´'ì•¼ğŸ€"; 

    let websocket = null;
    let isWebSocketConnected = false;

    // DOM ìš”ì†Œ
    const sendButton = document.getElementById('sendButton');
    const messageInput = document.getElementById('messageInput');
    const chatArea = document.querySelector('.chat-area');
    const headerTitle = document.getElementById('headerTitle');


    /* =========================================================
    * ìœ í‹¸ í•¨ìˆ˜
    * ======================================================= */
    // URLì—ì„œ roomIdë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getRoomIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('roomId'); 
    }

    // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ë‚´ë¦¬ëŠ” í•¨ìˆ˜
    function scrollToBottom(element) {
        element.scrollTop = element.scrollHeight;
    }

    // API í†µì‹  ì‹¤íŒ¨ ë° ì—ëŸ¬ UI ì²˜ë¦¬
    function handleApiError(error, loadingDiv, container, defaultMsg) {
        if (loadingDiv && loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
        console.error("API ì˜¤ë¥˜:", error);
        const errorMsg = { role: 'assistant', content: `${defaultMsg}: ${error.message || error}` };
        container.appendChild(createTextMessage(errorMsg));
        scrollToBottom(container);
    }

    // Loading Indicator ì œê±°
    function removeLoadingIndicator() {
        const loadingDivs = document.querySelectorAll('.typing-indicator');
        loadingDivs.forEach(div => {
            const messageBox = div.closest('.message-box');
            if (messageBox && messageBox.parentNode) {
                messageBox.parentNode.removeChild(messageBox);
            }
        });
    }

    /* =========================================================
 * í¬ì¶˜ ì¿ í‚¤ (Fortune Cookie) ë¡œì§
 * ======================================================= */

    const fortunes = [
    "ì˜¤ëŠ˜ì€ ë§¤ìš´ ìŒì‹ì„ ë¨¹ì–´ì•¼ ìš´ì´ í’€ë ¤ìš”! ìƒˆë¡œìš´ ê³³ì„ íƒí—˜í•˜ì„¸ìš”.",
    "ëœ»ë°–ì˜ í–‰ìš´ì´ ì°¾ì•„ì˜µë‹ˆë‹¤. ê°€ì¥ ì¹œí•œ ì¹œêµ¬ì—ê²Œ ì—°ë½í•´ ë³´ì„¸ìš”.",
    "ì˜¤ëœë§Œì— ë§Œë‚˜ëŠ” ì¹œêµ¬ì™€ ì¦ê±°ìš´ ì‹ì‚¬ë¥¼ í•˜ì„¸ìš”. í–‰ìš´ì´ ë”°ë¥¼ ê±°ì˜ˆìš”.",
    "ì˜¤ëŠ˜ì€ ë‹¬ì½¤í•œ ë””ì €íŠ¸ê°€ í–‰ìš´ì„ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤. ìƒˆë¡œìš´ ì¹´í˜ë¥¼ ë°©ë¬¸í•´ ë³´ì„¸ìš”.",
    "ìƒˆë¡œìš´ ë„ì „ì„ ë‘ë ¤ì›Œí•˜ì§€ ë§ˆì„¸ìš”. ìš©ê¸°ê°€ í° ë³´ìƒìœ¼ë¡œ ëŒì•„ì˜¬ ê±°ì˜ˆìš”.",
    "ìŠ¤íŠ¸ë ˆìŠ¤ëŠ” ê¸ˆë¬¼! ì˜¤ëŠ˜ì€ í¸ì•ˆí•œ ì‹ì‚¬ë¥¼ í•˜ë©° íœ´ì‹ì„ ì·¨í•˜ì„¸ìš”.",
    "ì˜¤ëŠ˜ì€ ë”°ëœ»í•œ í•œ ë¼ê°€ ìš´ì„ ë¶€ë¦…ë‹ˆë‹¤. ë§ˆìŒ ê°€ëŠ” ìŒì‹ì„ ì„ íƒí•´ ë³´ì„¸ìš”.",
    "ê°€ë³ê²Œ ì¦ê¸°ëŠ” ì‹ì‚¬ê°€ ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ë¶€ë“œëŸ½ê²Œ í’€ì–´ ì¤„ ê±°ì˜ˆìš”.",
    "ë°°ë¥¼ ë„ˆë¬´ ë¹µë¹µí•˜ê²Œ ì±„ìš°ê¸°ë³´ë‹¤, ê¸°ë¶„ ì¢‹ì•„ì§ˆ ë§Œí¼ë§Œ ë¨¹ìœ¼ë©´ í–‰ìš´ì´ ë”°ë¥¼ ê±°ì˜ˆìš”.",
    "ëŠê¸‹í•˜ê²Œ ì²œì²œíˆ ì”¹ì–´ ë¨¹ìœ¼ë©´ ë‹µë‹µí–ˆë˜ ë§ˆìŒì´ ì¡°ê¸ˆì”© í’€ë¦´ ê±°ì˜ˆìš”.",
    "ì¢‹ì•„í•˜ëŠ” ìŒì‹ì„ í•œ ë²ˆì¯¤ í—ˆìš©í•´ ì£¼ì„¸ìš”. ì‘ì€ í–‰ë³µì´ í° ìš´ì„ ë¶€ë¦…ë‹ˆë‹¤.",
    "í˜¼ì ë¨¹ë”ë¼ë„ ì‹íƒì„ ì˜ˆì˜ê²Œ ì°¨ë¦¬ë©´, ì˜ˆìƒ ëª» í•œ ì¢‹ì€ ì†Œì‹ì´ ì°¾ì•„ì˜¬ ê±°ì˜ˆìš”.",
    "ì˜¤ëŠ˜ ì²« ë¼ë¥¼ ì¦ê²ê²Œ ë¨¹ìœ¼ë©´ ë‚¨ì€ í•˜ë£¨ì˜ íë¦„ë„ ë°ì•„ì§‘ë‹ˆë‹¤.",
    "ë°°ê³ í””ì„ ì˜¤ë˜ ì°¸ì§€ ë§ê³  ì œë•Œ ì±™ê²¨ ë¨¹ìœ¼ë©´ ìƒê°ì§€ ëª»í•œ ë„ì›€ì´ ë“¤ì–´ì˜¬ ê±°ì˜ˆìš”.",
    "ê°„ë‹¨í•œ ê°„ì‹ í•˜ë‚˜ê°€ ì§€ì¹œ ë§ˆìŒì„ ë‹¤ë…ì—¬ ì¤„ ê±°ì˜ˆìš”. ìŠ¤ìŠ¤ë¡œë¥¼ ì¡°ê¸ˆì€ ì±™ê²¨ ì£¼ì„¸ìš”.",
    "ë‹¹ì´ ì‚´ì§ ë–¨ì–´ì¡Œë‹¤ë©´, ë‹¬ì½¤í•œ í•œ ì…ì´ ë§ˆìŒì˜ ì—¬ìœ ì™€ í•¨ê»˜ í–‰ìš´ë„ ë°ë ¤ì˜¬ ê±°ì˜ˆìš”.",
    "ì˜¤ëŠ˜ì€ ì‹ì‚¬ ì‹œê°„ë§Œí¼ì€ íœ´ì‹ ì‹œê°„ìœ¼ë¡œ ì •í•´ ë³´ì„¸ìš”. ê·¸ ì—¬ìœ ê°€ ì¢‹ì€ ì¸ì—°ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.",
    "ìµìˆ™í•œ ë§›ì˜ ì‹ì‚¬ê°€ ë¶ˆì•ˆí•œ ë§ˆìŒì„ ì•ˆì •ì‹œì¼œ ì¤„ ê±°ì˜ˆìš”. í¸ì•ˆí•œ ë©”ë‰´ë¥¼ ê³¨ë¼ ë³´ì„¸ìš”.",
    "ì‹ì‚¬í•  ë•Œ íœ´ëŒ€í°ì„ ì ì‹œ ë‚´ë ¤ë‘ë©´, ë¨¸ë¦¿ì†ì´ ë§‘ì•„ì§€ê³  ì¢‹ì€ ì•„ì´ë””ì–´ê°€ ë– ì˜¤ë¥¼ ê±°ì˜ˆìš”.",
    "ëˆ„êµ°ê°€ì™€ ìŒì‹ì„ ë‚˜ëˆ„ì–´ ë¨¹ìœ¼ë©´, ê·¸ë§Œí¼ ê¸°ì¨ê³¼ ìš´ë„ ë‚˜ëˆ„ì–´ ëŒì•„ì˜¬ ê±°ì˜ˆìš”.",
    "ì˜¤ëŠ˜ í•œ ë¼ëŠ” ìŠ¤ìŠ¤ë¡œë¥¼ ì‘ì›í•˜ëŠ” ì‹ì‚¬ë¡œ ì¤€ë¹„í•´ ë³´ì„¸ìš”. ìì‹ ê°ì´ í–‰ìš´ì„ ëŒì–´ë‹¹ê¹ë‹ˆë‹¤.",
    "ë¬¼ì„ ìì£¼ ë§ˆì‹œë©° ì‹ì‚¬ ë¦¬ë“¬ì„ ë§ì¶”ë©´ ëª¸ë„ ë§ˆìŒë„ ê°€ë²¼ì›Œì§€ê³  ì¼ì´ ìˆ˜ì›”í•´ì§ˆ ê±°ì˜ˆìš”.",
    "ì‹ì‚¬ ì „ì— ì˜¤ëŠ˜ ì˜ ë˜ê³  ì‹¶ì€ ì¼ì„ í•œ ë²ˆ ë– ì˜¬ë¦¬ë©´, ê·¸ ì—ë„ˆì§€ê°€ ìŒì‹ê³¼ í•¨ê»˜ ìŠ¤ë©°ë“¤ ê±°ì˜ˆìš”.",
    "ë°°ë¶€ë¦„ë³´ë‹¤ â€˜ë§Œì¡±ê°â€™ì„ ê¸°ì¤€ìœ¼ë¡œ ì‹ì‚¬ë¥¼ ë§ˆì¹˜ë©´, ë§ˆìŒì´ í•œê²° ë‹¨ë‹¨í•´ì§ˆ ê±°ì˜ˆìš”.",
    "ì¡°ìš©í•œ ê³³ì—ì„œ ì°¨ë¶„íˆ ë¨¹ëŠ” í•œ ë¼ê°€ ííŠ¸ëŸ¬ì§„ ìš´ì„ ì •ë¦¬í•´ ì¤„ ê±°ì˜ˆìš”.",
    "ì˜¤ëŠ˜ ë§ˆì§€ë§‰ í•œ ì…ê¹Œì§€ ê°ì‚¬í•œ ë§ˆìŒìœ¼ë¡œ ë¨¹ìœ¼ë©´, ë‚´ì¼ ë§ì´í•  í–‰ìš´ì˜ í¬ê¸°ê°€ ì»¤ì§‘ë‹ˆë‹¤.",
];

    function closeFortuneModal() {
    if (fortuneCookieModal) {
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        fortuneCookieModal.classList.remove('opacity-100');
        
        setTimeout(() => {
            fortuneCookieModal.classList.add('hidden');
            if (closedCookieSection && openedCookieSection) {
                closedCookieSection.classList.remove('hidden');
                openedCookieSection.classList.add('hidden');
                if (openCookieBtnInModal) openCookieBtnInModal.disabled = false; 
            }
            if (fortuneMessage) fortuneMessage.textContent = '';
        }, 300); // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„
    }
}

    function openFortuneModal() {
    if (fortuneCookieModal) {
        fortuneCookieModal.classList.remove('hidden');
        setTimeout(() => {
            fortuneCookieModal.classList.add('opacity-100');
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
    }
}

    function handleOpenCookie() {
    if (!openCookieBtnInModal || !fortuneMessage) return;

    openCookieBtnInModal.disabled = true;
    
    // ëœë¤ìœ¼ë¡œ ë©”ì‹œì§€ ì„ íƒ ë° ë Œë”ë§
    const randomIndex = Math.floor(Math.random() * fortunes.length);
    let messageText = fortunes[randomIndex];
    
    // *ì¹œêµ¬ë‹‰ë„¤ì„* ë¶€ë¶„ì„ ê°•ì¡°
    fortuneMessage.innerHTML = messageText.replace(/\*(.*?)\*/g, '<span class="text-blue-600 font-bold">@$1</span>'); 
    
    closedCookieSection.classList.add('hidden');
    openedCookieSection.classList.remove('hidden');
}

    /* =========================================================
    * DOM ìƒì„± ë° ë Œë”ë§ í•¨ìˆ˜
    * ======================================================= */
    // Loading Indicator ìƒì„± ë° ë Œë”ë§
    function renderLoadingIndicator() {
        const botLoadingDiv = document.createElement("div");
        botLoadingDiv.className = "message-box system-message";

        botLoadingDiv.innerHTML = `
            <div class="profile-icon">
                <img class="rounded-full object-cover" src="${chatbotProfileImg}" alt="Profile">
            </div>
            <div class="message-bubble system-bubble">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;

        chatArea.appendChild(botLoadingDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
        return botLoadingDiv;
    }
    

    // í”„ë¡œí•„ ì´ë¯¸ì§€ ìƒì„± (ì±—ë´‡/ë‹¤ë¥¸ ì‚¬ìš©ì)
    function createProfileIcon(msg, isAssistant) {
        const div = document.createElement('div');
        div.className = 'profile-icon';

        const img = document.createElement('img');
        img.className = 'rounded-full object-cover';
        img.alt = isAssistant ? 'Profile' : `${msg.sender_name} í”„ë¡œí•„`;
        img.src = isAssistant ? chatbotProfileImg : (msg.sender_profile_url || defaultProfileImg);

        div.appendChild(img);
        return div;
    }
    
    // ì¼ë°˜ ë©”ì‹œì§€(í…ìŠ¤íŠ¸) ìƒì„± (ì±—ë´‡/ë³¸ì¸/ë‹¤ë¥¸ ì‚¬ìš©ì)
    function createTextMessage(msg) {
        const messageBox = document.createElement('div');
        const isAssistant = (msg.role === 'assistant');

        // sender_idë¡œ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ë³´ë‚¸ ë©”ì‹œì§€ì¸ì§€ íŒë‹¨
        const isMyMessage = msg.sender_id === currentUserUid && !isAssistant;
        messageBox.className = `message-box ${isMyMessage ? 'user-message' : 'system-message'}`; 

        let bubbleContent;
        const contentHtml = marked.parse(msg.content);

        if (isAssistant) {
            // ì–´ì‹œìŠ¤í„´íŠ¸(ì±—ë´‡) ë©”ì‹œì§€
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble system-bubble';
            bubbleDiv.innerHTML = contentHtml;

            messageBox.appendChild(createProfileIcon(msg, true));
            messageBox.appendChild(bubbleDiv);

        } else if (isMyMessage) {
            // ë³¸ì¸ ë©”ì‹œì§€
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble user-bubble';
            bubbleDiv.innerHTML = contentHtml;

            messageBox.appendChild(bubbleDiv);

        } else {
            // ë‹¤ë¥¸ ì‚¬ìš©ì ë©”ì‹œì§€
            const senderName = msg.sender_name || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble system-bubble';
            bubbleDiv.innerHTML = `<div class="text-xs text-gray-600 mb-1">${senderName}</div>${contentHtml}`;

            messageBox.appendChild(createProfileIcon(msg, false));
            messageBox.appendChild(bubbleDiv);
        }

        return messageBox;
    }

    // ì£¼ì†Œ ì„¤ì • ë²„íŠ¼ ìƒì„± (í˜„ì¬ ìœ„ì¹˜/ì €ì¥ëœ ìœ„ì¹˜)
    function createLocationButtons(msg) {
        // ì €ì¥ëœ ìœ„ì¹˜ ì •ë³´ í™•ì¸ ë° íŒŒì‹±
        const savedLocationRaw = localStorage.getItem('savedBapickLocation');
        let savedLocation = null; // ì €ì¥ëœ ìœ„ì¹˜ ê°ì²´ (null ë˜ëŠ” íŒŒì‹±ëœ JSON)
        let savedLocationText = 'ì €ì¥ëœ ìœ„ì¹˜ ì‚¬ìš©';
        let hasSavedLocation = false; // ì €ì¥ëœ ìœ„ì¹˜ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€
        
        if (savedLocationRaw) {
            try {
                // savedLocationì— í• ë‹¹ (ìŠ¤ì½”í”„ ë¬¸ì œ í•´ê²°)
                savedLocation = JSON.parse(savedLocationRaw); 
                
                // ìœ íš¨ì„± ê²€ì‚¬ (lat, lon í•„ë“œ í™•ì¸)
                if (savedLocation && savedLocation.lat && savedLocation.lon) { 
                    // ë²„íŠ¼ì— í‘œì‹œí•  í…ìŠ¤íŠ¸
                    const displayAddress = savedLocation.name || savedLocation.address || 'ì €ì¥ëœ ìœ„ì¹˜';
                    savedLocationText = `${displayAddress}`;
                    hasSavedLocation = true;
                }
            } catch (e) {
                console.error("Error parsing savedBapickLocation:", e);
                savedLocation = null; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê°ì²´ë¥¼ nullë¡œ ìœ ì§€
            }
        }

        const container = document.createElement('div');
        container.className = 'location-buttons flex flex-row flex-wrap gap-2 mt-2 w-full';
        const locationBtnBase = 'location-select-button px-3 py-2 rounded-xl text-sm font-medium border transition';
        
        // í˜„ì¬ ìœ„ì¹˜ ì‚¬ìš© ë²„íŠ¼
        const currentBtn = document.createElement('button');
        currentBtn.textContent = 'í˜„ì¬ ìœ„ì¹˜ ì‚¬ìš© (GPS)';
        currentBtn.className = `${locationBtnBase} bg-[#FF7242] text-white hover:bg-[#E85F33]`;
        currentBtn.setAttribute('data-action', 'CURRENT_LOCATION');

        container.appendChild(currentBtn);

        // ì €ì¥ëœ ìœ„ì¹˜ ì‚¬ìš© ë²„íŠ¼ (ë¡œì»¬ìŠ¤íŠ¸ë¡œì§€ì— ì €ì¥ëœ ìœ„ì¹˜ê°€ ìˆì„ ê²½ìš°ì—ë§Œ ìƒì„±)
        if (hasSavedLocation) { 
            const savedBtn = document.createElement('button');
            savedBtn.textContent = savedLocationText;
            savedBtn.className   = `${locationBtnBase} bg-indigo-500 text-white hover:bg-indigo-600`;
            savedBtn.setAttribute('data-action', 'SAVED_LOCATION');
            savedBtn.setAttribute('data-lat', savedLocation.lat);
            savedBtn.setAttribute('data-lon', savedLocation.lon);
            
            container.appendChild(savedBtn); 
        }

        return container;
    }

    // ë‹¨ì¼ ì‹ë‹¹ ì¹´ë“œ ìƒì„±
    function createRestaurantCard(restaurant, index) {        
        let imageUrl = 'logo_bapick copy.png'; // ê¸°ë³¸ ì´ë¯¸ì§€
        
        if (restaurant.image) {
            imageUrl = restaurant.image;
        }
        
        // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œì™€ ì‹ë‹¹ ê°„ ê±°ë¦¬ ì •ë³´
        let distanceText = '';
        if (restaurant.distance_m !== undefined) {
            if (restaurant.distance_m < 1000) {
                // 1km ë¯¸ë§Œ: m ë‹¨ìœ„
                distanceText = `${restaurant.distance_m}m`;
            } else {
                // 1km ì´ìƒ: km ë‹¨ìœ„ (ì†Œìˆ˜ì  1ìë¦¬)
                distanceText = `${restaurant.distance_km}km`;
            }
        }

        return `
            <a href="detail.html?id=${restaurant.id}" class="restaurant-card overflow-hidden">
                <img 
                    src="${imageUrl}" 
                    alt="${restaurant.name} ì´ë¯¸ì§€" 
                    class="w-full h-32 object-cover rounded-t-lg"
                    onerror="console.error('Image load failed:', this.src); this.src='logo_bapick copy.png';"
                >
                <div class="p-3">
                    <h3 class="font-bold text-lg text-gray-900 truncate">${index + 1}. ${restaurant.name}</h3>
                    <p class="text-sm text-gray-500 mb-1 truncate">${restaurant.category}</p>
                    <p class="text-sm text-gray-500 mb-1 truncate">${restaurant.address}</p>
                    ${distanceText ? `<p class="text-xs text-[#FF7242] font-semibold mb-1"> ${distanceText}</p>` : ''}
                </div>
            </a>
        `;
    }

    // ì—¬ëŸ¬ ì‹ë‹¹ ì¹´ë“œ ì¶”ê°€
    function appendRestaurantcards(replyMessage, container) {
        try {
            const cardData = JSON.parse(replyMessage.content);

             // restaurant ë°°ì—´ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ ì•„ë¬´ê²ƒë„ ìƒì„±í•˜ì§€ ì•Šê³  ë¦¬í„´
            if (!cardData.restaurants || cardData.restaurants.length === 0) {
                console.log('[DEBUG] No restaurants in card data');
                return;
            }

            const cardsContainer = document.createElement('div');
            cardsContainer.className = `message-box ${replyMessage.role === 'assistant' ? 'system-message' : 'user-message'}`; 
            
            const cardsContentWrapper = document.createElement('div');
            cardsContentWrapper.className = 'restaurant-cards-container flex flex-row space-x-4 overflow-x-auto';

            cardData.restaurants.forEach((restaurant, index) => {
                const cardHtml = createRestaurantCard(restaurant, index); 
                cardsContentWrapper.insertAdjacentHTML('beforeend', cardHtml);
            });

            if (replyMessage.role === 'assistant') {
                cardsContainer.appendChild(createProfileIcon(replyMessage, true));
            }

            cardsContainer.appendChild(cardsContentWrapper);
            container.appendChild(cardsContainer);
            
        } catch (e) {
            console.error("Card JSON íŒŒì‹± ë° ë Œë”ë§ ì˜¤ë¥˜:", e);
            console.error("Content that failed:", replyMessage.content);
            container.appendChild(createTextMessage(replyMessage)); 
        }
    }

    // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ë Œë”ë§ ì²˜ë¦¬ (ì¼ë°˜ í…ìŠ¤íŠ¸/ì‹ë‹¹ ì¹´ë“œ/ìœ„ì¹˜ ì„¤ì •)
    function renderMessageByType(msg, chatArea) {
        const isCardMessage =
            msg.message_type === 'restaurant_cards' ||
            (msg.role === 'assistant' && msg.content && msg.content.trim().startsWith('{"restaurants":'));

        if (msg.message_type === 'location_select') {
            isExpectingAddress = true; 

            const messageBox = createTextMessage(msg);
            const bubbleDiv = messageBox.querySelector('.message-bubble');

            const buttonsDiv = createLocationButtons(msg);
            bubbleDiv.appendChild(buttonsDiv);

            chatArea.appendChild(messageBox);
        } else if (isCardMessage) {
            isExpectingAddress = false;
            appendRestaurantcards(msg, chatArea);
        } else {
            isExpectingAddress = false;
            chatArea.appendChild(createTextMessage(msg));
        }
    }

    // ë°©ì˜ íƒ€ì…(ê·¸ë£¹ì±„íŒ…/1:1)ì— ë”°ë¼ ì±„íŒ…ë°© ì œëª© ë° placeholder ì„¤ì •
    function setRoomTypeUI(data) {
        currentChatroomIsGroup = data.is_group || false;
        let roomName;
            
        if (currentChatroomIsGroup) {
            messageInput.placeholder = "@ë°¥í’€ì´ë¥¼ ì…ë ¥í•˜ë©´ ë´‡ì´ ì‘ë‹µí•©ë‹ˆë‹¤";
            roomName = `ë‹¨ì²´ì±„íŒ…ë°©`;
        } else {
            messageInput.placeholder = "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...";
            roomName = `ë°¥í’€ì´`;
        }

        headerTitle.textContent = data.chatroom_name || roomName; 
    }

    /* =========================================================
    * WebSocket
    * ======================================================= */
    // WebSocket ì—°ê²° ìƒì„± ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
    function connectWebSocket(roomId, token) {
        if (websocket) {
            websocket.close();
        }

        const wsUrl = FASTAPI_BASE_URL.replace('http://', 'ws://').replace('https://', 'wss://');
        websocket = new WebSocket(`${wsUrl}/chat/ws/${roomId}?token=${token}`);

        websocket.onopen = () => {
            console.log('WebSocket ì—°ê²°ë¨');
            isWebSocketConnected = true;
        };

        websocket.onmessage = (event) => {
            handleWebSocketMessage(event);
        };

        websocket.onerror = (error) => {
            console.error('WebSocket ì˜¤ë¥˜:', error);
        };

        websocket.onclose = () => {
            console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
            isWebSocketConnected = false;
        };
    }

    // ìˆ˜ì‹ í•œ WebSocket ë©”ì‹œì§€ ìœ í˜•ë³„ ì²˜ë¦¬
    function handleWebSocketMessage(event) {
        try {
            const data = JSON.parse(event.data);
            
            if (data.type === 'new_message') {
                const msg = data.message;
                
                // ìì‹ ì´ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ì´ë¯¸ í™”ë©´ì— í‘œì‹œí–ˆìœ¼ë¯€ë¡œ ë¬´ì‹œ
                if (msg.sender_id === currentUserUid && msg.role === 'user') {
                    return;
                }
                
                // ë¡œë”© UI ì œê±° (ë´‡ ì‘ë‹µì´ ì˜¤ë©´)
                if (msg.role === 'assistant') {
                    removeLoadingIndicator();
                }
                
                // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ë Œë”ë§
                renderMessageByType(msg, chatArea);

                scrollToBottom(chatArea);
            } else if (data.type === 'error') {
                console.error('ì„œë²„ ì—ëŸ¬:', data.message);
                
                removeLoadingIndicator();
                
                const errorMsg = { role: 'assistant', content: data.message };
                chatArea.appendChild(createTextMessage(errorMsg));
                scrollToBottom(chatArea);
            }
        } catch (err) {
            console.error('WebSocket ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', err);
        }
    }

    /* =========================================================
    * API ìš”ì²­
    * ======================================================= */
    // ì±„íŒ…ë°© ìƒì„± ë° ì´ˆê¸°í™”
    async function createChatRoom() {
        if (currentRoomId !== null || isCreatingRoom || !idToken) return;
        
        isCreatingRoom = true;
        sendButton.disabled = true;
        messageInput.disabled = true;

        chatArea.innerHTML = ''; 

        const headlineMessage = { role: 'assistant', content: greetingMessage }; 
        chatArea.appendChild(createTextMessage(headlineMessage));
        scrollToBottom(chatArea);

        const loadingDiv = renderLoadingIndicator();
        let success = false;
        
        try {
            const res = await fetch(`${FASTAPI_BASE_URL}/chat/create`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${idToken}`
                },
                body: JSON.stringify({})
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.detail || `API ìš”ì²­ ì‹¤íŒ¨`);
            }

            if (loadingDiv.parentNode) {
                loadingDiv.parentNode.removeChild(loadingDiv);
            }
            
            const data = await res.json();
            currentRoomId = data.chatroom_id; 
            setRoomTypeUI(data); // ë°©ì˜ íƒ€ì…(ê·¸ë£¹/1:1)ì— ë”°ë¼ ì œëª©ê³¼ placeholder ì„¤ì •
            
            connectWebSocket(currentRoomId, idToken);

            success = true;
            
        } catch (err) {
            handleApiError(err, loadingDiv, chatArea, "ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜");
        } finally {
            isCreatingRoom = false;
            sendButton.disabled = false;
            messageInput.disabled = false;
            
            if (success) {
                await renderInitialMessage(currentRoomId, chatArea); 
            }
        }
    }
    
    // ê¸°ì¡´ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ë¥¼ ë Œë”ë§
    async function loadMessages(roomId, container) {
        if (!idToken || !roomId || String(roomId).toLowerCase() === 'null') {
            console.error("ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜: ìœ íš¨í•˜ì§€ ì•Šì€ ë°© ë˜ëŠ” í† í°");
            container.innerHTML = ''; 
            return;
        }

        messageInput.disabled = true;

        try {
            const res = await fetch(`${FASTAPI_BASE_URL}/chat/messages/${roomId}`, {
                headers: { "Authorization": `Bearer ${idToken}` }
            });

            if (!res.ok) {
                if (res.status === 403) {
                    container.innerHTML = '<p class="text-center text-red-500">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                throw new Error(`ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨: ${res.status}`);
            }

            const data = await res.json();
            setRoomTypeUI(data); // ë°©ì˜ íƒ€ì…(ê·¸ë£¹/1:1)ì— ë”°ë¼ ì œëª©, placeholder ì„¤ì •

            container.innerHTML = ''; 
            const messages = Array.isArray(data) ? data : data.messages || [];

            messages.forEach(msg => {
                // ìœ„ì¹˜ ì •ë³´ ë©”ì‹œì§€ëŠ” ë Œë”ë§í•˜ì§€ ì•ŠìŒ
                const isLocationMessage = msg.content && msg.content.startsWith('[LOCATION_SELECTED:');

                if (!isLocationMessage) renderMessageByType(msg, chatArea);
            });

        } catch (err) {
            console.error("ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:", err);
            container.innerHTML = `<p class="text-center text-red-500">ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜: ${err.message}</p>`;
        } finally {
            scrollToBottom(container);
            messageInput.disabled = false;
            connectWebSocket(roomId, idToken);
        }
    }

    
    // ì±„íŒ…ë°© ì…ì¥ ì‹œ ì´ˆê¸° ì¶”ì²œ ë©”ì‹œì§€ ë Œë”ë§
    async function renderInitialMessage(roomId, container) {
        if (!idToken || !roomId) return;
        
        try {
            const res = await fetch(`${FASTAPI_BASE_URL}/chat/messages/${roomId}`, {
                headers: { "Authorization": `Bearer ${idToken}` }
            });

            if (!res.ok) { throw new Error("ë©”ì‹œì§€ ì¶”ê°€ ë¡œë“œ ì‹¤íŒ¨"); }
            
            const data = await res.json();
            const messages = Array.isArray(data) ? data : data.messages || [];

            if (messages.length > 1) {
                const secondMessage = messages[1]; 
                container.appendChild(createTextMessage(secondMessage));
            } else {
                console.warn("DBì— ìƒì„¸ ì¶”ì²œ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
                const warningMsg = { role: 'assistant', content: "ì˜¤í–‰ ë§ì¶¤ ì¶”ì²œ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };
                container.appendChild(createTextMessage(warningMsg));
            }

        } catch (err) {
            console.error("ì´ˆê¸° ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:", err);
            const errorMsg = { role: 'assistant', content: `[ì¶”ê°€ ë¡œë“œ ì˜¤ë¥˜]: ${err.message}` };
            container.appendChild(createTextMessage(errorMsg));
        } finally {
            scrollToBottom(container);
        }
    }

    // ë©”ì‹œì§€ ì „ì†¡
    async function sendMessage() {
        const messageText = messageInput.value.trim();
        if (!messageText) return;

        if (currentRoomId === null) {
            if (messageText) {
                await createChatRoom();
                if (currentRoomId !== null) {
                    await sendMessage();
                    return;
                }
                alert("ì§€ê¸ˆ ì±„íŒ…ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì£¼ì„¸ìš”.");
            }
            return;
        }

        if (!isWebSocketConnected) {
            alert("ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
            return;
        }
        
        // ìœ„ì¹˜ ì •ë³´ëŠ” í™”ë©´ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
        const isLocationMessage = messageText.startsWith('[LOCATION_SELECTED:');

        // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ë³¸ì¸ì´ ë³´ë‚¸ ë©”ì‹œì§€ ì¤‘ ì¼ë°˜ ë©”ì‹œì§€ë§Œ ë Œë”ë§
        if (!isLocationMessage) {
            const userMsg = { role: 'user', content: messageText, sender_id: currentUserUid};
            chatArea.appendChild(createTextMessage(userMsg));
        }

        const isSpecialTag = messageText.startsWith('[LOCATION_SELECTED:');

        if (isExpectingAddress && !isSpecialTag) {
            // ìœ„ì¹˜ ì…ë ¥ì„ ê¸°ëŒ€í•˜ëŠ” ìƒíƒœì´ê³ , íŠ¹ìˆ˜ íƒœê·¸ê°€ ì•„ë‹Œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¼ë©´ ì£¼ì†Œë¡œ ê°„ì£¼
            messageInput.disabled = true; 
            
            const success = await geocodeAddressAndSend(messageText);
            
            messageInput.disabled = false; 
            
            // ì„±ê³µì ìœ¼ë¡œ ì£¼ì†Œ ë³€í™˜ ë° íŠ¹ìˆ˜ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ
            if (success) {
                messageInput.value = ''; 
                sendButton.classList.remove('active');
                isExpectingAddress = false;
                return; 
            } 
            
            // ì‹¤íŒ¨ ì‹œ ì¬ì…ë ¥ ìœ ë„ë¥¼ ìœ„í•´ ì…ë ¥ì°½ë§Œ ì´ˆê¸°í™”í•˜ê³  ìƒíƒœëŠ” ìœ ì§€
            messageInput.value = ''; 
            sendButton.classList.remove('active');
            return;
        }

        // ë©”ì‹œì§€ ì „ì†¡ í›„ ì´ˆê¸°í™”
        scrollToBottom(chatArea);
        messageInput.value = '';
        sendButton.classList.remove('active');
        messageInput.disabled = true;

        // ë¡œë”© UI í‘œì‹œ (1:1 ì±„íŒ…ì´ê±°ë‚˜ ê·¸ë£¹ì±„íŒ…ì—ì„œ @ë°¥í’€ì´ë¥¼ í˜¸ì¶œí•œ ê²½ìš°)
        const shouldShowLoading = !currentChatroomIsGroup || messageText.includes('@ë°¥í’€ì´');
        let loadingDiv = null;
        if (shouldShowLoading) {
            loadingDiv = renderLoadingIndicator();
        }

        // WebSocketìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
        try {
            websocket.send(JSON.stringify({
                type: 'message',
                content: messageText
            }));
        } catch (err) {
            handleApiError(err, loadingDiv, chatArea, "ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            messageInput.disabled = false;
        }
    }

    // ìœ„ì¹˜ ì •ë³´ ì„œë²„ë¡œ ì „ì†¡
    async function sendLocationSelection(lat, lon, actionType) {
        const messageInput = document.getElementById('messageInput');
        const originalValue = messageInput.value;
        
        const backendMessage = `[LOCATION_SELECTED:${actionType}]|${lat}|${lon}`; 
        console.log(backendMessage);

        messageInput.value = backendMessage;
        
        try {
            await sendMessage(); 

        } catch (error) {
            console.error("ìœ„ì¹˜ ì •ë³´ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    /* =========================================================
    * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    * ======================================================= */
    // í˜„ì¬ ìœ„ì¹˜ (gps) ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    function handleCurrentLocationSelection() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    sendLocationSelection(lat, lon, 'CURRENT_LOCATION');
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    let errorMessage = 'GPS ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage += ' ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.';
                    }
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            // GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì¸ ê²½ìš°
            console.error('í˜„ì¬ ë¸Œë¼ìš°ì €ê°€ GPS ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'text');
        }
    }

    // ì €ì¥ëœ ìœ„ì¹˜ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ 
    function handleSavedLocationSelection(button) {
        const lat = button.getAttribute('data-lat');
        const lon = button.getAttribute('data-lon');

        if (lat && lon) {
            sendLocationSelection(lat, lon, 'SAVED_LOCATION');
        } else {
            console.error('ì €ì¥ëœ ìœ„ì¹˜ ì •ë³´ì— ì¢Œí‘œê°€ ëˆ„ë½ë˜ì–´ ì‹ë‹¹ ì¶”ì²œì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'text');
        }
    }

    messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.isComposing) {
            event.preventDefault(); 
            sendMessage(); 
        }
    });

    messageInput.addEventListener('input', () => {
        if (messageInput.value.trim() !== '') {
            sendButton.classList.add('active');
        } else {
            sendButton.classList.remove('active');
        }
    });

    sendButton.addEventListener('click', sendMessage);

    // ìœ„ì¹˜ ì„¤ì • ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('click', (event) => {
        const button = event.target.closest('.location-select-button');

        if (button) {
            const action = button.getAttribute('data-action');
            
            // í˜„ì¬ ìœ„ì¹˜ ì‚¬ìš© (GPS) ë²„íŠ¼ í´ë¦­ ì‹œ
            if (action === 'CURRENT_LOCATION') {
                handleCurrentLocationSelection();
            } 
            
            // ì €ì¥ëœ ìœ„ì¹˜ ì‚¬ìš© (SAVED_LOCATION) ë²„íŠ¼ í´ë¦­ ì‹œ
            else if (action === 'SAVED_LOCATION') {
                handleSavedLocationSelection(button);
            } 
        }
    });

// [+] ë²„íŠ¼ (ID: openFortuneBtn) í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
    const openFortuneBtn = document.getElementById('openFortuneBtn');
    if (openFortuneBtn) {
    openFortuneBtn.addEventListener('click', (event) => {
        event.preventDefault(); 
        openFortuneModal();
    });
}

// ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ ì—°ê²°
    if (openCookieBtnInModal) openCookieBtnInModal.addEventListener('click', handleOpenCookie);
    if (closeFortuneCookieBtn) closeFortuneCookieBtn.addEventListener('click', closeFortuneModal);
    if (confirmCookieBtn) confirmCookieBtn.addEventListener('click', closeFortuneModal);

// ëª¨ë‹¬ ì™¸ë¶€ (ë°°ê²½) í´ë¦­ ì‹œ ë‹«ê¸°
    if (fortuneCookieModal) {
    fortuneCookieModal.addEventListener('click', (e) => {
        if (e.target.id === 'fortuneCookieModal') {
            closeFortuneModal();
        }
    });
}


    window.addEventListener('beforeunload', () => {
        if (websocket) {
            websocket.close();
        }
    });

    /* =========================================================
    * ìœ„ì¹˜ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° ë° ìƒíƒœ
    * ======================================================= */
    let isExpectingAddress = false; // ì‚¬ìš©ìì˜ ë‹¤ìŒ ë©”ì‹œì§€ê°€ ì£¼ì†Œì¸ì§€ ì—¬ë¶€ (ë©”ë‰´ ì„ íƒ í›„ ì£¼ì†Œ ì…ë ¥ì„ ê¸°ëŒ€í•˜ëŠ” ìƒíƒœ)
    let kakaoPlaces = null;

    // Kakao Places ì´ˆê¸°í™” í•¨ìˆ˜
    function initializeKakaoPlaces() {
        if (typeof kakao !== 'undefined' && kakao.maps && kakao.maps.services) {
            kakaoPlaces = new kakao.maps.services.Places();
        } else {
            console.warn("Kakao Maps SDK (services, places) is not yet loaded.");
        }
    }

    // ì£¼ì†Œ ë¬¸ìì—´ì„ ì¢Œí‘œë¡œ ë³€í™˜í•˜ê³  íŠ¹ìˆ˜ ë©”ì‹œì§€ë¥¼ ì„œë²„ì— ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
    async function geocodeAddressAndSend(addressText) {
        if (!kakaoPlaces) {
            alert("ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            return false;
        }
        
        return new Promise((resolve) => {
            // Kakao Placesì˜ keywordSearchë¥¼ ì‚¬ìš©í•˜ì—¬ ì£¼ì†Œë¥¼ ê²€ìƒ‰
            kakaoPlaces.keywordSearch(addressText, async (data, status) => {
                if (status === kakao.maps.services.Status.OK) {
                    const firstPlace = data[0];
                    const lat = firstPlace.y; // ìœ„ë„
                    const lon = firstPlace.x; // ê²½ë„
                    
                    await sendLocationSelection(lat, lon, 'MANUAL_LOCATION'); 
                    
                    resolve(true); // ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ ì™„ë£Œ
                } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                    alert(`'${addressText}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ ì£¼ì†Œ ë˜ëŠ” ì¥ì†Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                    resolve(false); // ì „ì†¡ ì‹¤íŒ¨
                } else {
                    alert('ì£¼ì†Œ/ì¥ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                    resolve(false); // ì „ì†¡ ì‹¤íŒ¨
                }
            }, {
                size: 1, 
            });
        });
    }

    
    /* =========================================================
    * ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™”
    * ======================================================= */
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'index.html';
            return;
        }

        idToken = await user.getIdToken();
        currentUserUid = user.uid;
        
        const urlRoomId = getRoomIdFromUrl();

        initializeKakaoPlaces();
        if (urlRoomId) {
            currentRoomId = urlRoomId;
            await loadMessages(urlRoomId, chatArea);
        } else {
            await createChatRoom(); 
        }
    });
</script>
</body>
</html>
